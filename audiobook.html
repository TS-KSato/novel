<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy"
        content="default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline';">
    <title>„Ç™„Éº„Éá„Ç£„Ç™„Éñ„ÉÉ„ÇØ„Éó„É¨„Éº„É§„Éº</title>
    <style>
        /* Reset and Global Styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: system-ui, -apple-system, sans-serif;
            background: #f8f8f8;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            line-height: 1.6;
            color: #333;
        }

        /* Player Container */
        .player {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
            max-width: 400px;
            width: 100%;
            margin: 20px;
        }

        .player-title {
            text-align: center;
            margin-bottom: 20px;
            color: #005760;
            font-size: 1.5rem;
        }

        .book-info {
            text-align: center;
            margin-bottom: 20px;
        }

        .book-cover {
            width: 120px;
            height: 180px;
            margin: 0 auto 10px;
            background: url('cover04.png') center/cover;
            border-radius: 5px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .book-title {
            font-weight: bold;
            margin-bottom: 5px;
            color: #005760;
        }

        .book-author {
            font-size: 0.9em;
            color: #156b75;
        }

        /* Controls */
        .controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .button {
            background: #007a88;
            color: white;
            border: none;
            border-radius: 5px;
            padding: 10px 15px;
            cursor: pointer;
            font-size: 0.9em;
            font-weight: 500;
        }

        .button:hover {
            background: #005760;
        }

        #playPause {
            min-width: 100px;
        }

        /* Progress Bar */
        .progress-container {
            margin-bottom: 10px;
        }

        #seekBar {
            width: 100%;
            height: 8px;
            -webkit-appearance: none;
            appearance: none;
            background: #d8d8d8;
            border-radius: 4px;
            cursor: pointer;
        }

        #seekBar::-webkit-slider-thumb,
        #seekBar::-moz-range-thumb {
            width: 16px;
            height: 16px;
            background: #007a88;
            border-radius: 50%;
            cursor: pointer;
        }

        .time-display {
            display: flex;
            justify-content: space-between;
            font-size: 0.9em;
            color: #156b75;
            font-weight: 500;
        }

        /* Volume and Speed Controls */
        .volume-container,
        .speed-container {
            display: flex;
            align-items: center;
            margin-top: 15px;
        }

        .volume-icon {
            margin-right: 10px;
            color: #156b75;
            font-size: 1.2em;
            cursor: pointer;
        }

        #volumeControl {
            flex-grow: 1;
            height: 6px;
            -webkit-appearance: none;
            appearance: none;
            background: #d8d8d8;
            border-radius: 3px;
            cursor: pointer;
        }

        #volumeControl::-webkit-slider-thumb,
        #volumeControl::-moz-range-thumb {
            width: 14px;
            height: 14px;
            background: #007a88;
            border-radius: 50%;
            cursor: pointer;
        }

        .speed-buttons {
            display: flex;
            gap: 5px;
        }

        .speed-button {
            background: #e0f2f7;
            color: #005760;
            border: 1px solid #b3dfe7;
            border-radius: 3px;
            padding: 5px 8px;
            cursor: pointer;
            font-size: 0.8em;
        }

        .speed-button.active {
            background: #007a88;
            color: white;
        }

        /* Chapters */
        .chapter-container {
            margin-top: 20px;
            border-top: 1px solid #eee;
            padding-top: 15px;
        }

        .chapter-title {
            font-size: 0.9em;
            color: #005760;
            margin-bottom: 8px;
            font-weight: 500;
        }

        .chapter-select {
            width: 100%;
            padding: 8px 10px;
            border-radius: 5px;
            border: 1px solid #ccc;
            background-color: #f9f9f9;
            font-size: 0.9em;
            color: #333;
        }

        .error-message {
            color: #e74c3c;
            margin-top: 10px;
            padding: 8px;
            background-color: #fde2e2;
            border-radius: 4px;
            font-size: 0.9em;
            text-align: center;
            display: none;
        }

        @media (max-width: 600px) {
            .player {
                padding: 15px;
                margin: 10px;
            }

            .button {
                font-size: 0.8em;
                padding: 8px 12px;
            }

            #playPause {
                min-width: 80px;
            }

            .book-cover {
                width: 100px;
                height: 150px;
            }

            .speed-container {
                flex-direction: column;
                align-items: flex-start;
                gap: 5px;
            }

            .speed-label {
                margin-bottom: 5px;
            }
        }

        .player-footer {
            font-size: 0.8em;
            color: #333;
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px solid #eee;
            text-align: center;
            line-height: 1.5;
        }

        .footer-divider {
            border: 0;
            height: 1px;
            background-color: #eee;
            margin: 10px auto;
            width: 80%;
        }

        .player-footer .ai-notice p,
        .player-footer .copyright-info p {
            margin-bottom: 5px;
        }

        .player-footer .ai-notice p:last-child,
        .player-footer .copyright-info p:last-child {
            margin-bottom: 0;
        }
    </style>
</head>

<body>
    <div class="player">
        <h2 class="player-title">„Ç™„Éº„Éá„Ç£„Ç™„Éñ„ÉÉ„ÇØ„Éó„É¨„Éº„É§„Éº</h2>

        <div class="book-info">
            <div class="book-cover"></div>
            <div class="book-title">ÈäÄÊúà„ÅÆÂß´„Å®ÁçÖÂ≠ê„ÅÆÂÇ≠ÂÖµ</div>
            <div class="book-author">‰ªÆÊÉ≥‰∫∫Ê†ºÂ∑•Êàø√óAI</div>
        </div>

        <!-- „Ç™„Éº„Éá„Ç£„Ç™Ë¶ÅÁ¥† -->
        <audio id="audio" preload="metadata">
            <source src="voice04.mp3" type="audio/mpeg">
            „Åä‰Ωø„ÅÑ„ÅÆ„Éñ„É©„Ç¶„Ç∂„ÅØ„Ç™„Éº„Éá„Ç£„Ç™Ë¶ÅÁ¥†„Çí„Çµ„Éù„Éº„Éà„Åó„Å¶„ÅÑ„Åæ„Åõ„Çì„ÄÇ
        </audio>

        <!-- „Ç®„É©„Éº„É°„ÉÉ„Çª„Éº„Ç∏Ë°®Á§∫„Ç®„É™„Ç¢ -->
        <div id="errorMessage" class="error-message"></div>

        <!-- ÂÜçÁîü„Ç≥„É≥„Éà„É≠„Éº„É´ -->
        <div class="controls">
            <button id="rewind" class="button" aria-label="10ÁßíÂ∑ª„ÅçÊàª„Åó"><span class="control-icon">‚è™</span> 10Áßí</button>
            <button id="playPause" class="button" aria-label="ÂÜçÁîü">‚ñ∂ ÂÜçÁîü</button> <!-- ÂàùÊúüÁä∂ÊÖã„ÅØÂÜçÁîü -->
            <button id="forward" class="button" aria-label="10ÁßíÊó©ÈÄÅ„Çä">10Áßí <span class="control-icon">‚è©</span></button>
        </div>

        <!-- ÈÄ≤Ë°å„Éê„Éº -->
        <div class="progress-container">
            <div class="seekbar-container">
                <!-- „Ç¢„ÇØ„Çª„Ç∑„Éì„É™„ÉÜ„Ç£Âêë‰∏ä: aria-valuetext „ÇíËøΩÂä† -->
                <input type="range" id="seekBar" min="0" max="100" value="0" aria-label="ÂÜçÁîü‰ΩçÁΩÆ" aria-valuetext="0Áßí">
            </div>
            <div class="time-display">
                <span id="currentTime">0:00</span>
                <span id="duration">0:00</span>
            </div>
        </div>

        <!-- ÂÜçÁîüÈÄüÂ∫¶„Ç≥„É≥„Éà„É≠„Éº„É´ -->
        <div class="speed-container">
            <span class="speed-label">ÂÜçÁîüÈÄüÂ∫¶:</span>
            <div class="speed-buttons" id="speedButtonsContainer">
                <button class="speed-button" data-speed="0.75" aria-label="ÂÜçÁîüÈÄüÂ∫¶ 0.75ÂÄç">0.75x</button>
                <button class="speed-button active" data-speed="1" aria-label="ÂÜçÁîüÈÄüÂ∫¶ 1ÂÄç">1x</button> <!-- ÂàùÊúü„Ç¢„ÇØ„ÉÜ„Ç£„Éñ -->
                <button class="speed-button" data-speed="1.25" aria-label="ÂÜçÁîüÈÄüÂ∫¶ 1.25ÂÄç">1.25x</button>
                <button class="speed-button" data-speed="1.5" aria-label="ÂÜçÁîüÈÄüÂ∫¶ 1.5ÂÄç">1.5x</button>
                <button class="speed-button" data-speed="2" aria-label="ÂÜçÁîüÈÄüÂ∫¶ 2ÂÄç">2x</button>
            </div>
        </div>

        <!-- Èü≥Èáè„Ç≥„É≥„Éà„É≠„Éº„É´ -->
        <div class="volume-container">
            <!-- tabindex="0" „Åß„Éï„Ç©„Éº„Ç´„ÇπÂèØËÉΩ„Å´ -->
            <span class="volume-icon" role="button" tabindex="0" aria-label="„Éü„É•„Éº„ÉàÂàá„ÇäÊõø„Åà">üîä</span>
            <input type="range" id="volumeControl" min="0" max="1" step="0.1" value="1" aria-label="Èü≥Èáè">
        </div>

        <!-- „ÉÅ„É£„Éó„Çø„ÉºÈÅ∏Êäû -->
        <div class="chapter-container">
            <div class="chapter-title">„ÉÅ„É£„Éó„Çø„Éº</div>
            <select id="chapterSelect" class="chapter-select" aria-label="„ÉÅ„É£„Éó„Çø„ÉºÈÅ∏Êäû">
                <option value="0">Á¨¨1Á´†Ôºö„ÄåÈÅãÂëΩ„ÅÆ‰∫§Â∑ÆÁÇπ„Äç</option>
                <option value="60">Á¨¨2Á´†Ôºö„ÄåÈùô„Åã„Å™ÁçÖÂ≠ê„Å®È†ëÂõ∫„Å™Âß´„Äç</option>
                <option value="120">Á¨¨3Á´†Ôºö„ÄåÊòüÁ©∫„ÅÆ‰∏ã„ÅÆÂëäÁôΩ„Äç</option>
                <option value="180">Á¨¨4Á´†Ôºö„ÄåÂè§‰ª£Á•ûÊÆø„ÅÆÂïìÁ§∫„Äç</option>
                <option value="240">Á¨¨5Á´†Ôºö„ÄåÊñ∞„Åü„Å™ÈÅì„ÄÅ‰∫§„Çè„ÇãÊú™Êù•„Äç</option>
                <option value="300">„Ç®„Éî„É≠„Éº„Ç∞</option>
            </select>
        </div>
    </div>
    <footer class="player-footer">
        <div class="ai-notice">
            <p>Êú¨„Ç≥„É≥„ÉÜ„É≥„ÉÑ„ÅØ„ÄÅËëóËÄÖÂêçÁæ©„Äå‰ªÆÊÉ≥‰∫∫Ê†ºÂ∑•Êàø √ó AI„Äç„ÅÆ‰∏ã„ÄÅAIÊäÄË°ì„ÇíÊ¥ªÁî®„Åó„Å¶ÁîüÊàê„Åï„Çå„ÅüË¶ÅÁ¥†„ÇíÂê´„Åø„Åæ„Åô„ÄÇ‰∫∫Èñì„ÅÆ‰ºÅÁîª„ÉªÁõ£‰øÆ„Å´Âü∫„Å•„ÅçÂà∂‰Ωú„Åï„Çå„Å¶„ÅÑ„Åæ„Åô„ÄÇ</p>
        </div>
        <hr class="footer-divider">
        <div class="copyright-info">
            <p>¬© 2024 ‰ªÆÊÉ≥‰∫∫Ê†ºÂ∑•Êàø √ó AI</p>
            <p>Êé≤Ëºâ„Åï„Çå„Å¶„ÅÑ„Çã‰ΩúÂìÅ„ÅØ„Éï„Ç£„ÇØ„Ç∑„Éß„É≥„Åß„ÅÇ„Çä„ÄÅÂÆüÂú®„ÅÆ‰∫∫Áâ©„ÉªÂõ£‰ΩìÁ≠â„Å®„ÅØ‰∏ÄÂàáÈñ¢‰øÇ„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇËëó‰ΩúÊ®©Ê≥ï‰∏ä„ÅÆÂºïÁî®„ÅÆÁØÑÂõ≤„ÇíË∂Ö„Åà„Å¶„ÄÅÊú¨„Çµ„Ç§„Éà„ÅÆ„Ç≥„É≥„ÉÜ„É≥„ÉÑ„ÇíÁÑ°Êñ≠„ÅßÂà©Áî®„Åô„Çã„Åì„Å®„ÅØÁ¶ÅÊ≠¢„Åï„Çå„Å¶„ÅÑ„Åæ„Åô„ÄÇ</p>
        </div>
    </footer>

    <script>
        // JavaScriptÈÉ®ÂàÜ„ÅØÂ§âÊõ¥„Å™„Åó (ÂÖÉ„ÅÆ„Ç≥„Éº„Éâ„Çí„Åù„ÅÆ„Åæ„Åæ‰ΩøÁî®)
        (function () {
            'use strict'; // Âé≥Ê†º„É¢„Éº„Éâ„ÇíÊúâÂäπÂåñ

            // DOMË¶ÅÁ¥†„Çí‰∏ÄÂ∫¶„Å†„ÅëÂèñÂæó„Åó„Å¶„Ç≠„É£„ÉÉ„Ç∑„É•Ôºà„Éë„Éï„Ç©„Éº„Éû„É≥„ÇπÂêë‰∏äÔºâ
            const audio = document.getElementById('audio');
            const playPause = document.getElementById('playPause');
            const seekBar = document.getElementById('seekBar');
            const currentTimeDisplay = document.getElementById('currentTime');
            const durationDisplay = document.getElementById('duration');
            const volumeControl = document.getElementById('volumeControl');
            const volumeIcon = document.querySelector('.volume-icon');
            const chapterSelect = document.getElementById('chapterSelect');
            const errorMessage = document.getElementById('errorMessage');
            const controlsContainer = document.querySelector('.controls');
            const speedButtonsContainer = document.getElementById('speedButtonsContainer');

            // Áä∂ÊÖã„ÇíÁÆ°ÁêÜ„Åô„ÇãÂ§âÊï∞
            let isSeeking = false;
            let previousVolume = 1;
            let backupInterval = null;
            let settings = {
                volume: 1,
                speed: 1,
                position: 0
            };

            // Ë®≠ÂÆöÂÄ§„ÅÆÂèñÂæóÔºàÂÆâÂÖ®„Å™JSONËß£ÊûêÔºâ
            function getSavedSettings() {
                try {
                    const savedSettings = localStorage.getItem('audioSettings');
                    if (savedSettings) {
                        return JSON.parse(savedSettings);
                    }
                } catch (e) {
                    console.warn('Ë®≠ÂÆö„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü:', e);
                }
                return {};
            }

            // Ë®≠ÂÆöÂÄ§„ÅÆ‰øùÂ≠òÔºà‰∏ÄÂ∫¶„ÅÆ„Çπ„Éà„É¨„Éº„Ç∏„Ç¢„ÇØ„Çª„Çπ„Åß„Åô„Åπ„Å¶‰øùÂ≠òÔºâ
            function saveSettings() {
                try {
                    if (!isNaN(audio.currentTime) && !isNaN(audio.duration)) {
                        settings = {
                            volume: audio.volume,
                            speed: audio.playbackRate,
                            position: audio.currentTime
                        };
                        const safeSettings = Object.assign({}, settings);
                        localStorage.setItem('audioSettings', JSON.stringify(safeSettings));
                        // console.log('Settings saved:', safeSettings); // „Éá„Éê„ÉÉ„Ç∞Áî®
                    }
                } catch (e) {
                    console.warn('Ë®≠ÂÆö„ÅÆ‰øùÂ≠ò„Å´Â§±Êïó„Åó„Åæ„Åó„Åü:', e);
                }
            }

            // ÂäπÁéáÁöÑ„Å™„Çπ„É≠„ÉÉ„Éà„É™„É≥„Ç∞Èñ¢Êï∞ - „É°„É¢„É™„ÇíÂäπÁéáÁöÑ„Å´‰ΩøÁî®
            // (ÂÖÉ„ÅÆÂÆüË£Ö„ÇíÁ∂≠ÊåÅ)
            function throttle(fn, delay) {
                let lastCall = 0;
                let timeoutId = null; // ÈÅÖÂª∂ÂÆüË°åÁî®„ÅÆ„Çø„Ç§„Éû„ÉºID
                return function (...args) {
                    const now = Date.now();
                    const remaining = delay - (now - lastCall);

                    clearTimeout(timeoutId); // Êó¢Â≠ò„ÅÆÈÅÖÂª∂ÂÆüË°å„Çí„Ç≠„É£„É≥„Çª„É´

                    if (remaining <= 0) {
                        lastCall = now;
                        fn.apply(this, args);
                    } else {
                        // ÈÅÖÂª∂Âæå„Å´ÂÆüË°å„Åô„Çã„Çø„Ç§„Éû„Éº„ÇíË®≠ÂÆö
                        timeoutId = setTimeout(() => {
                            lastCall = Date.now();
                            fn.apply(this, args);
                        }, remaining);
                    }
                };
            }


            // ÂÆâÂÖ®„Å™HTMLË°®Á§∫Èñ¢Êï∞ÔºàXSSÂØæÁ≠ñÔºâ
            function safeSetText(element, text) {
                element.textContent = text;
            }

            // „Ç®„É©„Éº„É°„ÉÉ„Çª„Éº„Ç∏„ÇíË°®Á§∫„Åô„ÇãÈñ¢Êï∞
            function showError(message) {
                safeSetText(errorMessage, message);
                errorMessage.style.display = 'block';
                if ('inert' in HTMLElement.prototype) {
                    errorMessage.inert = false; // „Ç®„É©„ÉºË°®Á§∫‰∏≠„ÅØÊìç‰ΩúÂèØËÉΩ„Å´
                }

                setTimeout(() => {
                    errorMessage.style.display = 'none';
                    if ('inert' in HTMLElement.prototype) {
                        errorMessage.inert = true; // ÈùûË°®Á§∫„Å´„Å™„Å£„Åü„ÇâÂÜçÂ∫¶inert„Å´
                    }
                }, 5000);
            }

            // ÂÜçÁîü/‰∏ÄÊôÇÂÅúÊ≠¢„ÅÆÂàá„ÇäÊõø„Åà
            function togglePlayPause() {
                if (audio.paused) {
                    const playPromise = audio.play();
                    if (playPromise !== undefined) {
                        playPromise.then(() => {
                            safeSetText(playPause, '‚è∏ ‰∏ÄÊôÇÂÅúÊ≠¢');
                            playPause.setAttribute('aria-label', '‰∏ÄÊôÇÂÅúÊ≠¢');
                        }).catch(error => {
                            console.error('ÂÜçÁîü„Ç®„É©„Éº:', error);
                            // „Ç®„É©„Éº„Çø„Ç§„Éó„Å´Âü∫„Å•„ÅÑ„Å¶„Çà„ÇäÂÖ∑‰ΩìÁöÑ„Å™„É°„ÉÉ„Çª„Éº„Ç∏„ÇíË°®Á§∫
                            let userMessage = '„Ç™„Éº„Éá„Ç£„Ç™„ÅÆÂÜçÁîü‰∏≠„Å´„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü„ÄÇ';
                            if (error.name === 'NotAllowedError') {
                                userMessage = '„Éñ„É©„Ç¶„Ç∂„ÅÆÂà∂Èôê„Å´„Çà„ÇäËá™ÂãïÂÜçÁîü„Åß„Åç„Åæ„Åõ„Çì„Åß„Åó„Åü„ÄÇÂÜçÁîü„Éú„Çø„É≥„Çí„ÇØ„É™„ÉÉ„ÇØ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ';
                            } else if (error.name === 'NotSupportedError') {
                                userMessage = '„Ç™„Éº„Éá„Ç£„Ç™ÂΩ¢Âºè„Åå„Çµ„Éù„Éº„Éà„Åï„Çå„Å¶„ÅÑ„Å™„ÅÑÂèØËÉΩÊÄß„Åå„ÅÇ„Çä„Åæ„Åô„ÄÇ';
                            }
                            showError(userMessage);
                            // „Ç®„É©„ÉºÁô∫ÁîüÊôÇ„ÅØÂÜçÁîü„Éú„Çø„É≥„Å´Êàª„Åô
                            safeSetText(playPause, '‚ñ∂ ÂÜçÁîü');
                            playPause.setAttribute('aria-label', 'ÂÜçÁîü');
                        });
                    }
                } else {
                    audio.pause();
                    safeSetText(playPause, '‚ñ∂ ÂÜçÁîü');
                    playPause.setAttribute('aria-label', 'ÂÜçÁîü');
                }
            }

            // 10ÁßíÂ∑ª„ÅçÊàª„Åó
            function rewindAudio() {
                audio.currentTime = Math.max(0, audio.currentTime - 10);
                updateSeekBarAndChapter(); // Âç≥ÊôÇÊõ¥Êñ∞
            }

            // 10ÁßíÊó©ÈÄÅ„Çä
            function forwardAudio() {
                audio.currentTime = Math.min(audio.duration || 0, audio.currentTime + 10);
                updateSeekBarAndChapter(); // Âç≥ÊôÇÊõ¥Êñ∞
            }

            // ÊôÇÈñì„ÇíÁßí„Åã„ÇâË™≠„Åø‰∏ä„ÅíÂèØËÉΩ„Å™„ÉÜ„Ç≠„Çπ„ÉàÂΩ¢Âºè„Å´Â§âÊèõ
            function formatTimeForAria(seconds) {
                if (isNaN(seconds)) return "0Áßí";
                const minutes = Math.floor(seconds / 60);
                const remainingSeconds = Math.floor(seconds % 60);
                let text = "";
                if (minutes > 0) {
                    text += `${minutes}ÂàÜ`;
                }
                if (remainingSeconds > 0 || minutes === 0) {
                    text += `${remainingSeconds}Áßí`;
                }
                return text || "0Áßí";
            }

            // „Ç∑„Éº„ÇØ„Éê„Éº„ÅÆÊõ¥Êñ∞„Å®Êìç‰Ωú - ÊúÄÈÅ©ÂåñÁâà („Çπ„É≠„ÉÉ„Éà„É™„É≥„Ç∞ÈÅ©Áî®)
            const throttledUpdateSeekBar = throttle(() => {
                if (!isSeeking && !isNaN(audio.duration) && audio.duration > 0) {
                    const percent = (audio.currentTime / audio.duration) * 100;
                    seekBar.value = percent;
                    const currentTimeFormatted = formatTime(audio.currentTime);
                    safeSetText(currentTimeDisplay, currentTimeFormatted);
                    // „Ç¢„ÇØ„Çª„Ç∑„Éì„É™„ÉÜ„Ç£Âêë‰∏ä: aria-valuetext Êõ¥Êñ∞
                    seekBar.setAttribute('aria-valuetext', formatTimeForAria(audio.currentTime));
                    updateChapterSelectBasedOnTime();
                }
            }, 250); // 250msÈñìÈöî„ÅßÊõ¥Êñ∞

            // „Ç∑„Éº„ÇØ„Éê„Éº„Å®Ë°®Á§∫„ÇíÂç≥ÊôÇ„Å´Êõ¥Êñ∞„Åô„ÇãÈñ¢Êï∞ (Â∑ª„ÅçÊàª„Åó/Êó©ÈÄÅ„Çä/„ÉÅ„É£„Éó„Çø„ÉºÂ§âÊõ¥Áî®)
            function updateSeekBarAndChapter() {
                if (!isNaN(audio.duration) && audio.duration > 0) {
                    const percent = (audio.currentTime / audio.duration) * 100;
                    seekBar.value = percent;
                    const currentTimeFormatted = formatTime(audio.currentTime);
                    safeSetText(currentTimeDisplay, currentTimeFormatted);
                    // „Ç¢„ÇØ„Çª„Ç∑„Éì„É™„ÉÜ„Ç£Âêë‰∏ä: aria-valuetext Êõ¥Êñ∞
                    seekBar.setAttribute('aria-valuetext', formatTimeForAria(audio.currentTime));
                    updateChapterSelectBasedOnTime();
                } else {
                    // duration„Åå„Åæ„Å†‰∏çÊòé„Å™Â†¥Âêà„ÇÑ0„ÅÆÂ†¥Âêà„ÅÆÂàùÊúüÁä∂ÊÖã
                    seekBar.value = 0;
                    safeSetText(currentTimeDisplay, '0:00');
                    seekBar.setAttribute('aria-valuetext', '0Áßí');
                    updateChapterSelectBasedOnTime(); // „ÉÅ„É£„Éó„Çø„Éº„ÇÇÂàùÊúüÂåñ
                }
            }


            // ÁèæÂú®„ÅÆÂÜçÁîü‰ΩçÁΩÆ„Å´Âü∫„Å•„ÅÑ„Å¶„ÉÅ„É£„Éó„Çø„Éº„Çª„É¨„ÇØ„Éà„ÇíÊõ¥Êñ∞ÔºàÊúÄÈÅ©ÂåñÔºâ
            function updateChapterSelectBasedOnTime() {
                const currentTime = audio.currentTime;
                const options = chapterSelect.options;
                let selectedIndex = 0;

                for (let i = options.length - 1; i >= 0; i--) {
                    const optionTime = parseFloat(options[i].value);
                    // options[i].value „ÅåÊï∞ÂÄ§„Åß„Å™„ÅÑÂ†¥Âêà„ÇíËÄÉÊÖÆ
                    if (!isNaN(optionTime) && currentTime >= optionTime) {
                        selectedIndex = i;
                        break;
                    }
                }

                if (chapterSelect.selectedIndex !== selectedIndex) {
                    chapterSelect.selectedIndex = selectedIndex;
                }
            }

            // ÂÜçÁîüÈÄüÂ∫¶„ÅÆÂ§âÊõ¥ÔºàÊúÄÈÅ©ÂåñÔºâ
            function changePlaybackRate(event) {
                const target = event.target;
                // .speed-button „Åã„Å§ disabled „Åß„Å™„ÅÑ„Åì„Å®„ÇíÁ¢∫Ë™ç
                if (target.classList.contains('speed-button') && !target.disabled) {
                    const speed = parseFloat(target.getAttribute('data-speed'));
                    if (!isNaN(speed)) {
                        audio.playbackRate = speed;

                        // ÊúÄÈÅ©Âåñ: „Ç≥„É≥„ÉÜ„ÉäÂÜÖ„Åß„Éú„Çø„É≥„ÇíÊ§úÁ¥¢
                        const buttons = speedButtonsContainer.querySelectorAll('.speed-button');
                        buttons.forEach(button => button.classList.remove('active'));
                        target.classList.add('active');

                        settings.speed = speed; // ‰øùÂ≠òÁî®„Å´Êõ¥Êñ∞
                    }
                }
            }


            // Èü≥Èáè„Ç¢„Ç§„Ç≥„É≥„ÅÆÊõ¥Êñ∞
            function updateVolumeIcon() {
                const volume = audio.volume;
                const muted = audio.muted; // „Éü„É•„Éº„ÉàÁä∂ÊÖã„ÇÇËÄÉÊÖÆ
                let icon = 'üîä';
                let label = '„Éü„É•„Éº„ÉàÂàá„ÇäÊõø„Åà';

                if (muted || volume === 0) {
                    icon = 'üîá';
                    label = '„Éü„É•„Éº„ÉàËß£Èô§';
                } else if (volume < 0.5) {
                    icon = 'üîâ';
                }

                safeSetText(volumeIcon, icon);
                volumeIcon.setAttribute('aria-label', label);
            }

            // „Éü„É•„Éº„ÉàÂàá„ÇäÊõø„Åà
            function toggleMute() {
                audio.muted = !audio.muted; // audioË¶ÅÁ¥†„ÅÆmuted„Éó„É≠„Éë„ÉÜ„Ç£„Çí‰ΩøÁî®
                // Ë¶ã„ÅüÁõÆ„ÅÆÂêåÊúü (ÂøÖÈ†à„Åß„ÅØ„Å™„ÅÑ„Åå„ÄÅ„É¶„Éº„Ç∂„Éº‰ΩìÈ®ìÂêë‰∏ä)
                if (audio.muted) {
                    previousVolume = audio.volume; // „Éü„É•„Éº„ÉàÂâç„ÅÆÈü≥Èáè„Çí‰øùÂ≠ò
                    volumeControl.value = 0; // „Çπ„É©„Ç§„ÉÄ„Éº„Çí0„Å´„Åô„Çã
                } else {
                    // „Éü„É•„Éº„ÉàËß£Èô§ÊôÇ„ÄÅÂÖÉ„ÅÆÈü≥Èáè„Å´Êàª„Åô„Åã„ÄÅÊúÄÂ∞èÈü≥Èáè„Å´„Åô„Çã„ÅãÈÅ∏Êäû
                    // „Åì„Åì„Åß„ÅØ„Éü„É•„Éº„ÉàÂâç„ÅÆÈü≥Èáè„Å´Êàª„Åô
                    audio.volume = previousVolume > 0 ? previousVolume : 0.1; // 0„Å†„Å£„ÅüÂ†¥Âêà„ÅØÂ∞ë„ÅóÈü≥Èáè„ÇíÂá∫„Åô
                    volumeControl.value = audio.volume;
                }

                updateVolumeIcon();
                // „Éü„É•„Éº„ÉàÁä∂ÊÖãËá™‰Ωì„ÅØ‰øùÂ≠ò„Åõ„Åö„ÄÅÈü≥Èáè„ÅÆ„Åø‰øùÂ≠ò (settings.volume„ÅØ„Éè„É≥„Éâ„É´ÂÜÖ„ÅßÊõ¥Êñ∞)
                settings.volume = audio.volume; // „Éü„É•„Éº„ÉàÁä∂ÊÖã„Å´Èñ¢„Çè„Çâ„ÅöÁèæÂú®„ÅÆÈü≥Èáè„Çí‰øùÂ≠òÂØæË±°„Å®„Åô„Çã
            }


            // ÊôÇÈñì„ÅÆ„Éï„Ç©„Éº„Éû„ÉÉ„ÉàÔºàÁßí„ÇíMM:SSÂΩ¢Âºè„Å´Â§âÊèõÔºâ- ÊúÄÈÅ©ÂåñÁâà
            function formatTime(seconds) {
                if (isNaN(seconds) || seconds < 0) return "0:00"; // ‰∏çÊ≠£„Å™ÂÄ§„ÅØ0:00„Å´
                const minutes = Math.floor(seconds / 60);
                const remainingSeconds = Math.floor(seconds % 60);
                return `${minutes}:${remainingSeconds < 10 ? '0' : ''}${remainingSeconds}`;
            }

            // „Ç≥„É≥„Éà„É≠„Éº„É´„Ç§„Éô„É≥„Éà„ÅÆÂá¶ÁêÜ - „Ç§„Éô„É≥„ÉàÂßî‰ªª„Çí‰ΩøÁî®
            function handleControlsClick(event) {
                const target = event.target.closest('button'); // „Éú„Çø„É≥Ëá™‰Ωì„Åæ„Åü„ÅØ„Åù„ÅÆÂ≠êË¶ÅÁ¥†„Çí„ÇØ„É™„ÉÉ„ÇØ„Åó„ÅüÂ†¥Âêà„Å´ÂØæÂøú
                if (!target || target.disabled) return; // disabled„Å™„ÇâÁÑ°Ë¶ñ

                switch (target.id) {
                    case 'playPause':
                        togglePlayPause();
                        break;
                    case 'rewind':
                        rewindAudio();
                        break;
                    case 'forward':
                        forwardAudio();
                        break;
                }
            }

            // „Ç≠„Éº„Éú„Éº„Éâ„Ç§„Éô„É≥„Éà„Éè„É≥„Éâ„É©Ôºà„Çπ„É≠„ÉÉ„Éà„É™„É≥„Ç∞ÈÅ©Áî®Ôºâ
            const handleGlobalKeydown = throttle((e) => {
                // „ÉÜ„Ç≠„Çπ„ÉàÂÖ•Âäõ‰∏≠„Å™„Å©„ÅØ„Ç∑„Éß„Éº„Éà„Ç´„ÉÉ„Éà„ÇíÁÑ°ÂäπÂåñ
                const activeEl = document.activeElement;
                const isTextInput = activeEl.tagName === 'INPUT' || activeEl.tagName === 'TEXTAREA' || activeEl.isContentEditable;

                if (isTextInput) return; // „ÉÜ„Ç≠„Çπ„ÉàÂÖ•Âäõ‰∏≠„ÅØÁÑ°Ë¶ñ

                // „Çπ„Éö„Éº„Çπ„Ç≠„Éº„Åß„ÅÆÂÜçÁîü/‰∏ÄÊôÇÂÅúÊ≠¢ („Éú„Çø„É≥/„Çª„É¨„ÇØ„Éà‰ª•Â§ñ„Å´„Éï„Ç©„Éº„Ç´„Çπ„Åå„ÅÇ„ÇãÂ†¥Âêà)
                if (e.code === 'Space' && activeEl.tagName !== 'BUTTON' && activeEl.tagName !== 'SELECT' && activeEl !== volumeIcon) {
                    e.preventDefault();
                    togglePlayPause();
                }

                // Â∑¶Âè≥Áü¢Âç∞„Ç≠„Éº„ÅßÂ∑ª„ÅçÊàª„Åó/Êó©ÈÄÅ„Çä („Çπ„É©„Ç§„ÉÄ„Éº/„Çª„É¨„ÇØ„Éà/Èü≥Èáè„Ç¢„Ç§„Ç≥„É≥‰ª•Â§ñ„Å´„Éï„Ç©„Éº„Ç´„Çπ„Åå„ÅÇ„ÇãÂ†¥Âêà)
                if (activeEl !== seekBar && activeEl !== volumeControl && activeEl !== chapterSelect && activeEl !== volumeIcon) {
                    if (e.code === 'ArrowLeft') {
                        e.preventDefault(); // „Éö„Éº„Ç∏„ÅÆ„Çπ„ÇØ„É≠„Éº„É´„ÇíÈò≤„ÅêÂ†¥Âêà
                        rewindAudio();
                    } else if (e.code === 'ArrowRight') {
                        e.preventDefault(); // „Éö„Éº„Ç∏„ÅÆ„Çπ„ÇØ„É≠„Éº„É´„ÇíÈò≤„ÅêÂ†¥Âêà
                        forwardAudio();
                    }
                }

                // M„Ç≠„Éº„Åß„Éü„É•„Éº„ÉàÂàá„ÇäÊõø„Åà
                if (e.code === 'KeyM') {
                    toggleMute();
                }

            }, 150); // 150ms„ÅÆ„Çπ„É≠„ÉÉ„Éà„É™„É≥„Ç∞

            // „ÉÅ„É£„Éó„Çø„ÉºÈÅ∏Êäû„Éè„É≥„Éâ„É©
            function handleChapterChange() {
                const chapterTime = parseFloat(chapterSelect.value);
                if (!isNaN(chapterTime)) {
                    audio.currentTime = chapterTime;
                    updateSeekBarAndChapter(); // Âç≥ÊôÇÊõ¥Êñ∞
                    // ‰øÆÊ≠£: Ëá™ÂãïÂÜçÁîü„ÅØË°å„Çè„Å™„ÅÑ
                }
            }

            // Èü≥ÈáèÂ§âÊõ¥„Éè„É≥„Éâ„É©
            function handleVolumeChange() {
                const newVolume = parseFloat(volumeControl.value);
                audio.volume = newVolume;
                // audio.muted „ÅØ volumechange „Ç§„Éô„É≥„ÉàÂÜÖ„ÅßËá™ÂãïÊõ¥Êñ∞„Åï„Çå„Çã„Åì„Å®„ÅåÂ§ö„ÅÑ„Åå„ÄÅÊòéÁ§∫ÁöÑ„Å´ÂêåÊúü
                audio.muted = (newVolume === 0);

                if (newVolume > 0 && !audio.muted) { // „Éü„É•„Éº„Éà„Åï„Çå„Å¶„Åä„Çâ„Åö„ÄÅÈü≥Èáè„Åå„ÅÇ„ÇãÂ†¥Âêà„ÅÆ„ÅøpreviousVolumeÊõ¥Êñ∞
                    previousVolume = newVolume;
                }

                updateVolumeIcon(); // „Ç¢„Ç§„Ç≥„É≥Êõ¥Êñ∞„ÅØ volumechange „Ç§„Éô„É≥„Éà„Å´‰ªª„Åõ„Å¶„ÇÇËâØ„ÅÑ„Åå„ÄÅÂç≥ÊôÇÂèçÊò†„ÅÆ„Åü„ÇÅ„Å´„Åì„Åì„Åß„ÇÇÂëº„Å∂
                settings.volume = audio.volume; // ‰øùÂ≠òÁî®„Å´Êõ¥Êñ∞
            }


            // „Ç∑„Éº„ÇØ„Éê„ÉºÂÖ•Âäõ„Éè„É≥„Éâ„É© („Éâ„É©„ÉÉ„Ç∞‰∏≠)
            function handleSeekBarInput() {
                isSeeking = true; // „Ç∑„Éº„ÇØ‰∏≠„Éï„É©„Ç∞„ÇíÁ´ã„Å¶„Çã
                // requestAnimationFrame„Çí‰ΩøÁî®„Åó„Å¶„Çπ„É†„Éº„Ç∫„Å™Êõ¥Êñ∞
                requestAnimationFrame(() => {
                    if (!isNaN(audio.duration) && audio.duration > 0) {
                        const seekTime = audio.duration * (seekBar.value / 100);
                        // currentTime „ÅØÁõ¥Êé•Ë®≠ÂÆö„Åõ„Åö„ÄÅË°®Á§∫„ÅÆ„ÅøÊõ¥Êñ∞
                        safeSetText(currentTimeDisplay, formatTime(seekTime));
                        seekBar.setAttribute('aria-valuetext', formatTimeForAria(seekTime));
                    }
                });
            }

            // „Ç∑„Éº„ÇØ„Éê„ÉºÂ§âÊõ¥ÂÆå‰∫Ü„Éè„É≥„Éâ„É© („Éû„Ç¶„Çπ„Ç¢„ÉÉ„Éó/„Çø„ÉÉ„ÉÅ„Ç®„É≥„Éâ/ÂÄ§Â§âÊõ¥Âæå)
            function handleSeekBarChange() {
                if (!isNaN(audio.duration) && audio.duration > 0) {
                    const seekTime = audio.duration * (seekBar.value / 100);
                    audio.currentTime = seekTime;
                }
                // isSeeking „Éï„É©„Ç∞„ÅØ timeupdate „Éè„É≥„Éâ„É©ÂÜÖ„Åß audio.seeking „ÇíË¶ã„ÇãÊñπ„ÅåÁ¢∫ÂÆü„Åã„ÇÇ„Åó„Çå„Å™„ÅÑ
                // „Åå„ÄÅ„Åì„Åì„Åß„ÅØÂÖÉ„ÅÆ„É≠„Ç∏„ÉÉ„ÇØ„ÇíÁ∂≠ÊåÅ
                isSeeking = false; // „Ç∑„Éº„ÇØÂÆå‰∫Ü
                // „Ç∑„Éº„ÇØÂÆå‰∫ÜÂæå„ÄÅUI„ÇíÊúÄÁµÇÁä∂ÊÖã„Å´Êõ¥Êñ∞
                updateSeekBarAndChapter();
            }


            // „Ç§„Éô„É≥„Éà„É™„Çπ„Éä„Éº„Çí„Çª„ÉÉ„Éà„Ç¢„ÉÉ„Éó„Åô„ÇãÈñ¢Êï∞
            function setupEventListeners() {
                // „Ç™„Éº„Éá„Ç£„Ç™„Ç§„Éô„É≥„Éà
                audio.addEventListener('timeupdate', throttledUpdateSeekBar); // „Çπ„É≠„ÉÉ„Éà„É™„É≥„Ç∞„Åï„Çå„ÅüÊõ¥Êñ∞
                audio.addEventListener('loadedmetadata', () => {
                    safeSetText(durationDisplay, formatTime(audio.duration));
                    seekBar.max = 100; // duration„ÅåÁ¢∫ÂÆö„Åó„Åü„Çâmax„ÇíË®≠ÂÆö
                    updateSeekBarAndChapter(); // ÂàùÊúü‰ΩçÁΩÆÂèçÊò†„ÅÆ„Åü„ÇÅ
                });
                audio.addEventListener('durationchange', () => { // duration„ÅåÂ§â„Çè„ÇãÂèØËÉΩÊÄß„ÇÇËÄÉÊÖÆ
                    safeSetText(durationDisplay, formatTime(audio.duration));
                    seekBar.max = 100;
                    updateSeekBarAndChapter();
                });
                audio.addEventListener('volumechange', () => {
                    // audio.volume „Åæ„Åü„ÅØ audio.muted „ÅÆÂ§âÊõ¥„ÇíÊ§úÁü•
                    volumeControl.value = audio.muted ? 0 : audio.volume; // „Çπ„É©„Ç§„ÉÄ„Éº‰ΩçÁΩÆ„ÇíÂêåÊúü
                    if (!audio.muted && audio.volume > 0) {
                        previousVolume = audio.volume; // „Éü„É•„Éº„ÉàËß£Èô§Áî®„Å´‰øùÂ≠ò
                    }
                    updateVolumeIcon(); // „Ç¢„Ç§„Ç≥„É≥„ÇíÊõ¥Êñ∞
                    settings.volume = audio.volume; // Ë®≠ÂÆö‰øùÂ≠òÁî®„Å´Êõ¥Êñ∞
                });

                // „Ç™„Éº„Éá„Ç£„Ç™„Ç®„É©„Éº„Éè„É≥„Éâ„É™„É≥„Ç∞
                audio.addEventListener('error', (e) => {
                    let errorMsg = '„Ç™„Éº„Éá„Ç£„Ç™„Éï„Ç°„Ç§„É´„ÅÆË™≠„ÅøËæº„Åø‰∏≠„Å´‰∏çÊòé„Å™„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü„ÄÇ';
                    if (audio.error) {
                        switch (audio.error.code) {
                            case 1: // MEDIA_ERR_ABORTED
                                errorMsg = '„É¶„Éº„Ç∂„Éº„Å´„Çà„Å£„Å¶ÂÜçÁîü„Åå‰∏≠Ê≠¢„Åï„Çå„Åæ„Åó„Åü„ÄÇ';
                                break;
                            case 2: // MEDIA_ERR_NETWORK
                                errorMsg = '„Éç„ÉÉ„Éà„ÉØ„Éº„ÇØ„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü„ÄÇÊé•Á∂ö„ÇíÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ';
                                break;
                            case 3: // MEDIA_ERR_DECODE
                                errorMsg = '„Ç™„Éº„Éá„Ç£„Ç™„ÅÆ„Éá„Ç≥„Éº„Éâ„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ„Éï„Ç°„Ç§„É´„ÅåÁ†¥Êêç„Åó„Å¶„ÅÑ„Çã„Åã„ÄÅÂΩ¢Âºè„Åå„Çµ„Éù„Éº„Éà„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì„ÄÇ';
                                break;
                            case 4: // MEDIA_ERR_SRC_NOT_SUPPORTED
                                errorMsg = '„Ç™„Éº„Éá„Ç£„Ç™„Éï„Ç°„Ç§„É´„ÅåË¶ã„Å§„Åã„Çâ„Å™„ÅÑ„Åã„ÄÅ„Çµ„Éù„Éº„Éà„Åï„Çå„Å¶„ÅÑ„Å™„ÅÑÂΩ¢Âºè„Åß„Åô„ÄÇ';
                                break;
                        }
                    }
                    showError(errorMsg);
                    console.error('Audio error:', audio.error, e);
                    // „Ç®„É©„Éº„Å´„Çà„Å£„Å¶„ÅØÂÜçÁîü„Éú„Çø„É≥„Çí„É™„Çª„ÉÉ„Éà
                    safeSetText(playPause, '‚ñ∂ ÂÜçÁîü');
                    playPause.setAttribute('aria-label', 'ÂÜçÁîü');
                    // UIË¶ÅÁ¥†„ÇíÁÑ°ÂäπÂåñ„Åô„Çã„Å™„Å©„ÅÆÂá¶ÁêÜ„ÇÇÊ§úË®é
                    // ‰æã: seekBar.disabled = true; controlsContainer.querySelectorAll('button').forEach(b => b.disabled = true);
                });

                // „Ç≥„É≥„Éà„É≠„Éº„É´„Éú„Çø„É≥„Ç§„Éô„É≥„Éà („Ç§„Éô„É≥„ÉàÂßî‰ªª)
                controlsContainer.addEventListener('click', handleControlsClick);

                // ÂÜçÁîüÈÄüÂ∫¶„Éú„Çø„É≥„ÅÆ„Ç§„Éô„É≥„ÉàÂßî‰ªª
                speedButtonsContainer.addEventListener('click', changePlaybackRate);

                // „Ç∑„Éº„ÇØ„Éê„Éº„Ç§„Éô„É≥„Éà
                seekBar.addEventListener('input', handleSeekBarInput);
                seekBar.addEventListener('change', handleSeekBarChange);
                seekBar.addEventListener('touchstart', () => isSeeking = true, { passive: true });
                seekBar.addEventListener('touchend', handleSeekBarChange); // touchend„Åß„ÇÇchange„Å®ÂêåÊßò„ÅÆÂá¶ÁêÜ


                // „ÉÅ„É£„Éó„Çø„ÉºÈÅ∏Êäû„Ç§„Éô„É≥„Éà
                chapterSelect.addEventListener('change', handleChapterChange);

                // Èü≥Èáè„Ç≥„É≥„Éà„É≠„Éº„É´„Ç§„Éô„É≥„Éà
                volumeControl.addEventListener('input', handleVolumeChange);
                volumeIcon.addEventListener('click', toggleMute);
                volumeIcon.addEventListener('keydown', (e) => {
                    // Enter or Space„Åß„Éü„É•„Éº„ÉàÂàá„ÇäÊõø„Åà
                    if (e.code === 'Enter' || e.code === 'Space') {
                        e.preventDefault(); // „Éú„Çø„É≥„Å®„Åó„Å¶„ÅÆÊåôÂãïÔºà„Çπ„Éö„Éº„Çπ„Åß„ÅÆ„Çπ„ÇØ„É≠„Éº„É´„Å™„Å©Ôºâ„ÇíÊäëÂà∂
                        toggleMute();
                    }
                });

                // „Ç∞„É≠„Éº„Éê„É´„Ç≠„Éº„Éú„Éº„Éâ„Ç∑„Éß„Éº„Éà„Ç´„ÉÉ„Éà
                document.addEventListener('keydown', handleGlobalKeydown);

                // ÂÜçÁîüÁµÇ‰∫ÜÊôÇ„ÅÆÂá¶ÁêÜ
                audio.addEventListener('ended', () => {
                    safeSetText(playPause, '‚ñ∂ ÂÜçÁîü');
                    playPause.setAttribute('aria-label', 'ÂÜçÁîü');
                    audio.currentTime = 0; // ÂÜçÁîü‰ΩçÁΩÆ„ÇíÊúÄÂàù„Å´Êàª„ÅôÔºà„Ç™„Éó„Ç∑„Éß„É≥Ôºâ
                    updateSeekBarAndChapter(); // UI„ÇíÊõ¥Êñ∞
                    // ÂøÖË¶Å„Åß„ÅÇ„Çå„Å∞Ê¨°„ÅÆ„Éà„É©„ÉÉ„ÇØ„Å∏ÁßªÂãï„Å™„Å©„ÅÆ„É≠„Ç∏„ÉÉ„ÇØ„Çí„Åì„Åì„Å´ËøΩÂä†
                    saveSettings(); // ÂÜçÁîüÁµÇ‰∫ÜÊôÇ„Å´„ÇÇÁä∂ÊÖã„Çí‰øùÂ≠ò
                });

                // „Éö„Éº„Ç∏Ë°®Á§∫Áä∂ÊÖãÂ§âÊõ¥ÊôÇ„ÅÆ‰øùÂ≠ò („Çà„Çä‰ø°È†ºÊÄß„ÅåÈ´ò„ÅÑ)
                document.addEventListener('visibilitychange', () => {
                    if (document.visibilityState === 'hidden') {
                        saveSettings();
                    }
                });

                // „Éö„Éº„Ç∏Èõ¢ËÑ±Ââç„ÅÆ‰øùÂ≠ò („Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØ)
                window.addEventListener('beforeunload', saveSettings);
            }

            // ÂàùÊúüÂåñ
            function init() {
                const savedSettings = getSavedSettings();
                // console.log('Loaded settings:', savedSettings); // „Éá„Éê„ÉÉ„Ç∞Áî®

                // Èü≥ÈáèË®≠ÂÆö (volumechange„Ç§„Éô„É≥„Éà„Å´‰æùÂ≠ò„Åõ„ÅöÂàùÊúüÂåñ)
                let initialVolume = 1;
                if (savedSettings.volume !== undefined) {
                    const volume = parseFloat(savedSettings.volume);
                    if (!isNaN(volume)) {
                        initialVolume = volume;
                    }
                } else {
                    initialVolume = parseFloat(volumeControl.value); // HTML„ÅÆ„Éá„Éï„Ç©„É´„ÉàÂÄ§
                }
                audio.volume = initialVolume;
                audio.muted = (initialVolume === 0); // 0„Å™„Çâ„Éü„É•„Éº„Éà
                volumeControl.value = audio.muted ? 0 : audio.volume; // „Çπ„É©„Ç§„ÉÄ„Éº„ÇÇÂêåÊúü
                previousVolume = initialVolume > 0 ? initialVolume : 1; // „Éü„É•„Éº„ÉàËß£Èô§Áî®
                updateVolumeIcon(); // ÂàùÊúü„Ç¢„Ç§„Ç≥„É≥Ë®≠ÂÆö

                // ÂÜçÁîüÈÄüÂ∫¶
                if (savedSettings.speed !== undefined) {
                    const speed = parseFloat(savedSettings.speed);
                    if (!isNaN(speed)) {
                        audio.playbackRate = speed;
                        // ÊúÄÈÅ©Âåñ: „Ç≥„É≥„ÉÜ„ÉäÂÜÖ„Åß„Éú„Çø„É≥„ÇíÊ§úÁ¥¢
                        const buttons = speedButtonsContainer.querySelectorAll('.speed-button');
                        buttons.forEach(button => {
                            button.classList.toggle('active', parseFloat(button.getAttribute('data-speed')) === speed);
                        });
                    }
                } // „Éá„Éï„Ç©„É´„Éà„ÅØHTML„ÅßÊåáÂÆö„Åï„Çå„Åü 'active' „ÇØ„É©„Çπ„Å´Âæì„ÅÜ

                // ÂâçÂõû„ÅÆÂÜçÁîü‰ΩçÁΩÆ („É°„Çø„Éá„Éº„Çø„É≠„Éº„ÉâÂæå„Å´Ë®≠ÂÆö)
                const applyInitialPosition = () => {
                    // „É™„Çπ„Éä„ÉºÂâäÈô§
                    audio.removeEventListener('loadedmetadata', applyInitialPositionHandler);
                    audio.removeEventListener('durationchange', applyInitialPositionHandler);

                    if (savedSettings.position !== undefined) {
                        const position = parseFloat(savedSettings.position);
                        // duration „ÅåÊúâÂäπ„Å™Â†¥Âêà„Å´„ÅÆ„Åø‰ΩçÁΩÆ„ÇíË®≠ÂÆö
                        if (!isNaN(position) && !isNaN(audio.duration) && audio.duration > 0 && position < audio.duration) {
                            // Â∞ë„ÅóÂæÖ„Å£„Å¶„Åã„ÇâË®≠ÂÆö„Åô„Çã„Å®ÂÆâÂÆö„Åô„ÇãÂ†¥Âêà„Åå„ÅÇ„Çã
                            setTimeout(() => {
                                audio.currentTime = position;
                                updateSeekBarAndChapter(); // UIÊõ¥Êñ∞„ÇÇÈÅÖÂª∂Âæå„Å´
                            }, 100); // 100msÂæÖ„Å§ (ÂøÖË¶Å„Å´Âøú„Åò„Å¶Ë™øÊï¥)
                        } else {
                            updateSeekBarAndChapter(); // ‰ΩçÁΩÆË®≠ÂÆö„Åó„Å™„ÅÑÂ†¥Âêà„ÇÇUIÊõ¥Êñ∞
                        }
                    } else {
                        updateSeekBarAndChapter(); // ‰øùÂ≠ò„Åï„Çå„Åü‰ΩçÁΩÆ„Åå„Å™„ÅÑÂ†¥Âêà„ÇÇUIÊõ¥Êñ∞
                    }
                };

                // loadedmetadata / durationchange „Ç§„Éô„É≥„Éà„Éè„É≥„Éâ„É©
                const applyInitialPositionHandler = () => {
                    // readyState„ÇíÁ¢∫Ë™ç„Åó„Å¶„Åã„ÇâÂÆüË°å
                    if (audio.readyState >= 1) { // HAVE_METADATA or higher
                        applyInitialPosition();
                    }
                };


                // audio „ÅÆÊ∫ñÂÇôÁä∂ÊÖã„Å´Âøú„Åò„Å¶„É™„Çπ„Éä„Éº„ÇíË®≠ÂÆö
                if (audio.readyState >= 1) { // HAVE_METADATA or higher
                    // „Åô„Åß„Å´„É°„Çø„Éá„Éº„Çø„Åå„ÅÇ„Çå„Å∞Â∞ë„ÅóÂæÖ„Å£„Å¶„Åã„Çâ‰ΩçÁΩÆË®≠ÂÆö„ÇíË©¶„Åø„Çã
                    setTimeout(() => {
                        applyInitialPosition();
                    }, 100);
                } else {
                    // „Åæ„Å†„Å™„Çâ„Ç§„Éô„É≥„Éà„ÇíÂæÖ„Å§
                    audio.addEventListener('loadedmetadata', applyInitialPositionHandler, { once: true }); // ‰∏ÄÂ∫¶„Å†„ÅëÂÆüË°å
                    audio.addEventListener('durationchange', applyInitialPositionHandler, { once: true }); // durationchange „ÇÇ‰∏ÄÂ∫¶„Å†„Åëlisten
                }


                // ÂÆöÊúü‰øùÂ≠ò„ÅØÂªÉÊ≠¢
                // clearInterval(backupInterval); // ‰∏çË¶Å

                // InertÂ±ûÊÄß„ÅÆÂàùÊúüË®≠ÂÆö
                if ('inert' in HTMLElement.prototype) {
                    errorMessage.inert = true; // ÊúÄÂàù„ÅØÈùûË°®Á§∫„Å™„ÅÆ„Åßinert
                }

                // ÂàùÊúüUIÁä∂ÊÖãÊõ¥Êñ∞
                updateSeekBarAndChapter();
            }

            // „É°„É¢„É™„É™„Éº„ÇØ„ÇíÈò≤„Åê„Åü„ÇÅ„ÅÆ„É™„ÇΩ„Éº„ÇπËß£ÊîæÈñ¢Êï∞ („Ç≥„É°„É≥„Éà„Ç¢„Ç¶„ÉàÁ∂≠ÊåÅ)
            function cleanupResources() {
                // console.log("Resources cleaned up."); // „Éá„Éê„ÉÉ„Ç∞Áî®
            }

            // „Ç¢„Éó„É™„Ç±„Éº„Ç∑„Éß„É≥ÂÆüË°å
            function runApp() {
                init();
                setupEventListeners();
            }

            // DOM„ÅåÂÆåÂÖ®„Å´Ë™≠„ÅøËæº„Åæ„Çå„Åü„ÇâÂàùÊúüÂåñ
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', runApp);
            } else {
                runApp(); // „Åô„Åß„Å´Ë™≠„ÅøËæº„ÅøÂÆå‰∫Ü„Åó„Å¶„ÅÑ„ÇãÂ†¥Âêà
            }
        })();
    </script>
</body>

</html>
