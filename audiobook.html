<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy"
        content="default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline';">
    <title>ã‚ªãƒ¼ãƒ‡ã‚£ã‚ªãƒ–ãƒƒã‚¯ãƒ—ãƒ¬ãƒ¼ãƒ¤ãƒ¼</title>
    <style>
        /* Reset and Global Styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: system-ui, -apple-system, sans-serif;
            background: #f8f8f8;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            line-height: 1.6;
            color: #333;
        }

        /* Player Container */
        .player {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
            max-width: 400px;
            width: 100%;
            margin: 20px;
        }

        .player-title {
            text-align: center;
            margin-bottom: 20px;
            color: #005760;
            font-size: 1.5rem;
        }

        .book-info {
            text-align: center;
            margin-bottom: 20px;
        }

        .book-cover {
            width: 120px;
            height: 180px;
            margin: 0 auto 10px;
            background: url('cover04.png') center/cover;
            border-radius: 5px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .book-title {
            font-weight: bold;
            margin-bottom: 5px;
            color: #005760;
        }

        .book-author {
            font-size: 0.9em;
            color: #156b75;
        }

        /* Controls */
        .controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .button {
            background: #007a88;
            color: white;
            border: none;
            border-radius: 5px;
            padding: 10px 15px;
            cursor: pointer;
            font-size: 0.9em;
            font-weight: 500;
        }

        .button:hover {
            background: #005760;
        }

        #playPause {
            min-width: 100px;
        }

        /* Progress Bar */
        .progress-container {
            margin-bottom: 10px;
        }

        #seekBar {
            width: 100%;
            height: 8px;
            -webkit-appearance: none;
            appearance: none;
            background: #d8d8d8;
            border-radius: 4px;
            cursor: pointer;
        }

        #seekBar::-webkit-slider-thumb,
        #seekBar::-moz-range-thumb {
            width: 16px;
            height: 16px;
            background: #007a88;
            border-radius: 50%;
            cursor: pointer;
        }

        .time-display {
            display: flex;
            justify-content: space-between;
            font-size: 0.9em;
            color: #156b75;
            font-weight: 500;
        }

        /* Volume and Speed Controls */
        .volume-container,
        .speed-container {
            display: flex;
            align-items: center;
            margin-top: 15px;
        }

        .volume-icon {
            margin-right: 10px;
            color: #156b75;
            font-size: 1.2em;
            cursor: pointer;
        }

        #volumeControl {
            flex-grow: 1;
            height: 6px;
            -webkit-appearance: none;
            appearance: none;
            background: #d8d8d8;
            border-radius: 3px;
            cursor: pointer;
        }

        #volumeControl::-webkit-slider-thumb,
        #volumeControl::-moz-range-thumb {
            width: 14px;
            height: 14px;
            background: #007a88;
            border-radius: 50%;
            cursor: pointer;
        }

        .speed-buttons {
            display: flex;
            gap: 5px;
        }

        .speed-button {
            background: #e0f2f7;
            color: #005760;
            border: 1px solid #b3dfe7;
            border-radius: 3px;
            padding: 5px 8px;
            cursor: pointer;
            font-size: 0.8em;
        }

        .speed-button.active {
            background: #007a88;
            color: white;
        }

        /* Chapters */
        .chapter-container {
            margin-top: 20px;
            border-top: 1px solid #eee;
            padding-top: 15px;
        }

        .chapter-title {
            font-size: 0.9em;
            color: #005760;
            margin-bottom: 8px;
            font-weight: 500;
        }

        .chapter-select {
            width: 100%;
            padding: 8px 10px;
            border-radius: 5px;
            border: 1px solid #ccc;
            background-color: #f9f9f9;
            font-size: 0.9em;
            color: #333;
        }

        .error-message {
            color: #e74c3c;
            margin-top: 10px;
            padding: 8px;
            background-color: #fde2e2;
            border-radius: 4px;
            font-size: 0.9em;
            text-align: center;
            display: none;
        }

        @media (max-width: 600px) {
            .player {
                padding: 15px;
                margin: 10px;
            }

            .button {
                font-size: 0.8em;
                padding: 8px 12px;
            }

            #playPause {
                min-width: 80px;
            }

            .book-cover {
                width: 100px;
                height: 150px;
            }

            .speed-container {
                flex-direction: column;
                align-items: flex-start;
                gap: 5px;
            }

            .speed-label {
                margin-bottom: 5px;
            }
        }

        .player-footer {
            font-size: 0.8em;
            color: #333;
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px solid #eee;
            text-align: center;
            line-height: 1.5;
        }

        .footer-divider {
            border: 0;
            height: 1px;
            background-color: #eee;
            margin: 10px auto;
            width: 80%;
        }

        .player-footer .ai-notice p,
        .player-footer .copyright-info p {
            margin-bottom: 5px;
        }

        .player-footer .ai-notice p:last-child,
        .player-footer .copyright-info p:last-child {
            margin-bottom: 0;
        }
    </style>
</head>

<body>
    <div class="player">
        <h2 class="player-title">ã‚ªãƒ¼ãƒ‡ã‚£ã‚ªãƒ–ãƒƒã‚¯ãƒ—ãƒ¬ãƒ¼ãƒ¤ãƒ¼</h2>

        <div class="book-info">
            <div class="book-cover"></div>
            <div class="book-title">éŠ€æœˆã®å§«ã¨ç…å­ã®å‚­å…µ</div>
            <div class="book-author">ä»®æƒ³äººæ ¼å·¥æˆ¿Ã—AI</div>
        </div>

        <!-- ã‚ªãƒ¼ãƒ‡ã‚£ã‚ªè¦ç´  -->
        <audio id="audio" preload="metadata">
            <source src="voice04.mp3" type="audio/mpeg">
            ãŠä½¿ã„ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯ã‚ªãƒ¼ãƒ‡ã‚£ã‚ªè¦ç´ ã‚’ã‚µãƒãƒ¼ãƒˆã—ã¦ã„ã¾ã›ã‚“ã€‚
        </audio>

        <!-- ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤ºã‚¨ãƒªã‚¢ -->
        <div id="errorMessage" class="error-message"></div>

        <!-- å†ç”Ÿã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ« -->
        <div class="controls">
            <button id="rewind" class="button" aria-label="10ç§’å·»ãæˆ»ã—"><span class="control-icon">âª</span> 10ç§’</button>
            <button id="playPause" class="button" aria-label="å†ç”Ÿ">â–¶ å†ç”Ÿ</button> <!-- åˆæœŸçŠ¶æ…‹ã¯å†ç”Ÿ -->
            <button id="forward" class="button" aria-label="10ç§’æ—©é€ã‚Š">10ç§’ <span class="control-icon">â©</span></button>
        </div>

        <!-- é€²è¡Œãƒãƒ¼ -->
        <div class="progress-container">
            <div class="seekbar-container">
                <!-- ã‚¢ã‚¯ã‚»ã‚·ãƒ“ãƒªãƒ†ã‚£å‘ä¸Š: aria-valuetext ã‚’è¿½åŠ  -->
                <input type="range" id="seekBar" min="0" max="100" value="0" aria-label="å†ç”Ÿä½ç½®" aria-valuetext="0ç§’">
            </div>
            <div class="time-display">
                <span id="currentTime">0:00</span>
                <span id="duration">0:00</span>
            </div>
        </div>

        <!-- å†ç”Ÿé€Ÿåº¦ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ« -->
        <div class="speed-container">
            <span class="speed-label">å†ç”Ÿé€Ÿåº¦:</span>
            <div class="speed-buttons" id="speedButtonsContainer">
                <button class="speed-button" data-speed="0.75" aria-label="å†ç”Ÿé€Ÿåº¦ 0.75å€">0.75x</button>
                <button class="speed-button active" data-speed="1" aria-label="å†ç”Ÿé€Ÿåº¦ 1å€">1x</button> <!-- åˆæœŸã‚¢ã‚¯ãƒ†ã‚£ãƒ– -->
                <button class="speed-button" data-speed="1.25" aria-label="å†ç”Ÿé€Ÿåº¦ 1.25å€">1.25x</button>
                <button class="speed-button" data-speed="1.5" aria-label="å†ç”Ÿé€Ÿåº¦ 1.5å€">1.5x</button>
                <button class="speed-button" data-speed="2" aria-label="å†ç”Ÿé€Ÿåº¦ 2å€">2x</button>
            </div>
        </div>

        <!-- éŸ³é‡ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ« -->
        <div class="volume-container">
            <!-- tabindex="0" ã§ãƒ•ã‚©ãƒ¼ã‚«ã‚¹å¯èƒ½ã« -->
            <span class="volume-icon" role="button" tabindex="0" aria-label="ãƒŸãƒ¥ãƒ¼ãƒˆåˆ‡ã‚Šæ›¿ãˆ">ğŸ”Š</span>
            <input type="range" id="volumeControl" min="0" max="1" step="0.1" value="1" aria-label="éŸ³é‡">
        </div>

        <!-- ãƒãƒ£ãƒ—ã‚¿ãƒ¼é¸æŠ -->
        <div class="chapter-container">
            <div class="chapter-title">ãƒãƒ£ãƒ—ã‚¿ãƒ¼</div>
            <select id="chapterSelect" class="chapter-select" aria-label="ãƒãƒ£ãƒ—ã‚¿ãƒ¼é¸æŠ">
                <option value="0">ç¬¬1ç« ï¼šã€Œé‹å‘½ã®äº¤å·®ç‚¹ã€</option>
                <option value="60">ç¬¬2ç« ï¼šã€Œé™ã‹ãªç…å­ã¨é ‘å›ºãªå§«ã€</option>
                <option value="120">ç¬¬3ç« ï¼šã€Œæ˜Ÿç©ºã®ä¸‹ã®å‘Šç™½ã€</option>
                <option value="180">ç¬¬4ç« ï¼šã€Œå¤ä»£ç¥æ®¿ã®å•“ç¤ºã€</option>
                <option value="240">ç¬¬5ç« ï¼šã€Œæ–°ãŸãªé“ã€äº¤ã‚ã‚‹æœªæ¥ã€</option>
                <option value="300">ã‚¨ãƒ”ãƒ­ãƒ¼ã‚°</option>
            </select>
        </div>
    </div>
    <footer class="player-footer">
        <div class="ai-notice">
            <p>æœ¬ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã¯ã€è‘—è€…åç¾©ã€Œä»®æƒ³äººæ ¼å·¥æˆ¿ Ã— AIã€ã®ä¸‹ã€AIæŠ€è¡“ã‚’æ´»ç”¨ã—ã¦ç”Ÿæˆã•ã‚ŒãŸè¦ç´ ã‚’å«ã¿ã¾ã™ã€‚äººé–“ã®ä¼ç”»ãƒ»ç›£ä¿®ã«åŸºã¥ãåˆ¶ä½œã•ã‚Œã¦ã„ã¾ã™ã€‚</p>
        </div>
        <hr class="footer-divider">
        <div class="copyright-info">
            <p>Â© 2024 ä»®æƒ³äººæ ¼å·¥æˆ¿ Ã— AI</p>
            <p>æ²è¼‰ã•ã‚Œã¦ã„ã‚‹ä½œå“ã¯ãƒ•ã‚£ã‚¯ã‚·ãƒ§ãƒ³ã§ã‚ã‚Šã€å®Ÿåœ¨ã®äººç‰©ãƒ»å›£ä½“ç­‰ã¨ã¯ä¸€åˆ‡é–¢ä¿‚ã‚ã‚Šã¾ã›ã‚“ã€‚è‘—ä½œæ¨©æ³•ä¸Šã®å¼•ç”¨ã®ç¯„å›²ã‚’è¶…ãˆã¦ã€æœ¬ã‚µã‚¤ãƒˆã®ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’ç„¡æ–­ã§åˆ©ç”¨ã™ã‚‹ã“ã¨ã¯ç¦æ­¢ã•ã‚Œã¦ã„ã¾ã™ã€‚</p>
        </div>
    </footer>

    <script>
        // JavaScriptéƒ¨åˆ†ã¯å¤‰æ›´ãªã— (å…ƒã®ã‚³ãƒ¼ãƒ‰ã‚’ãã®ã¾ã¾ä½¿ç”¨)
        (function () {
            'use strict'; // å³æ ¼ãƒ¢ãƒ¼ãƒ‰ã‚’æœ‰åŠ¹åŒ–

            // DOMè¦ç´ ã‚’ä¸€åº¦ã ã‘å–å¾—ã—ã¦ã‚­ãƒ£ãƒƒã‚·ãƒ¥ï¼ˆãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹å‘ä¸Šï¼‰
            const audio = document.getElementById('audio');
            const playPause = document.getElementById('playPause');
            const seekBar = document.getElementById('seekBar');
            const currentTimeDisplay = document.getElementById('currentTime');
            const durationDisplay = document.getElementById('duration');
            const volumeControl = document.getElementById('volumeControl');
            const volumeIcon = document.querySelector('.volume-icon');
            const chapterSelect = document.getElementById('chapterSelect');
            const errorMessage = document.getElementById('errorMessage');
            const controlsContainer = document.querySelector('.controls');
            const speedButtonsContainer = document.getElementById('speedButtonsContainer');

            // çŠ¶æ…‹ã‚’ç®¡ç†ã™ã‚‹å¤‰æ•°
            let isSeeking = false;
            let previousVolume = 1;
            let backupInterval = null;
            let settings = {
                volume: 1,
                speed: 1,
                position: 0
            };

            // è¨­å®šå€¤ã®å–å¾—ï¼ˆå®‰å…¨ãªJSONè§£æï¼‰
            function getSavedSettings() {
                try {
                    const savedSettings = localStorage.getItem('audioSettings');
                    if (savedSettings) {
                        return JSON.parse(savedSettings);
                    }
                } catch (e) {
                    console.warn('è¨­å®šã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ:', e);
                }
                return {};
            }

            // è¨­å®šå€¤ã®ä¿å­˜ï¼ˆä¸€åº¦ã®ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‚¢ã‚¯ã‚»ã‚¹ã§ã™ã¹ã¦ä¿å­˜ï¼‰
            function saveSettings() {
                try {
                    if (!isNaN(audio.currentTime) && !isNaN(audio.duration)) {
                        settings = {
                            volume: audio.volume,
                            speed: audio.playbackRate,
                            position: audio.currentTime
                        };
                        const safeSettings = Object.assign({}, settings);
                        localStorage.setItem('audioSettings', JSON.stringify(safeSettings));
                        // console.log('Settings saved:', safeSettings); // ãƒ‡ãƒãƒƒã‚°ç”¨
                    }
                } catch (e) {
                    console.warn('è¨­å®šã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ:', e);
                }
            }

            // åŠ¹ç‡çš„ãªã‚¹ãƒ­ãƒƒãƒˆãƒªãƒ³ã‚°é–¢æ•° - ãƒ¡ãƒ¢ãƒªã‚’åŠ¹ç‡çš„ã«ä½¿ç”¨
            // (å…ƒã®å®Ÿè£…ã‚’ç¶­æŒ)
            function throttle(fn, delay) {
                let lastCall = 0;
                let timeoutId = null; // é…å»¶å®Ÿè¡Œç”¨ã®ã‚¿ã‚¤ãƒãƒ¼ID
                return function (...args) {
                    const now = Date.now();
                    const remaining = delay - (now - lastCall);

                    clearTimeout(timeoutId); // æ—¢å­˜ã®é…å»¶å®Ÿè¡Œã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«

                    if (remaining <= 0) {
                        lastCall = now;
                        fn.apply(this, args);
                    } else {
                        // é…å»¶å¾Œã«å®Ÿè¡Œã™ã‚‹ã‚¿ã‚¤ãƒãƒ¼ã‚’è¨­å®š
                        timeoutId = setTimeout(() => {
                            lastCall = Date.now();
                            fn.apply(this, args);
                        }, remaining);
                    }
                };
            }


            // å®‰å…¨ãªHTMLè¡¨ç¤ºé–¢æ•°ï¼ˆXSSå¯¾ç­–ï¼‰
            function safeSetText(element, text) {
                element.textContent = text;
            }

            // ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤ºã™ã‚‹é–¢æ•°
            function showError(message) {
                safeSetText(errorMessage, message);
                errorMessage.style.display = 'block';
                if ('inert' in HTMLElement.prototype) {
                    errorMessage.inert = false; // ã‚¨ãƒ©ãƒ¼è¡¨ç¤ºä¸­ã¯æ“ä½œå¯èƒ½ã«
                }

                setTimeout(() => {
                    errorMessage.style.display = 'none';
                    if ('inert' in HTMLElement.prototype) {
                        errorMessage.inert = true; // éè¡¨ç¤ºã«ãªã£ãŸã‚‰å†åº¦inertã«
                    }
                }, 5000);
            }

            // å†ç”Ÿ/ä¸€æ™‚åœæ­¢ã®åˆ‡ã‚Šæ›¿ãˆ
            function togglePlayPause() {
                if (audio.paused) {
                    const playPromise = audio.play();
                    if (playPromise !== undefined) {
                        playPromise.then(() => {
                            safeSetText(playPause, 'â¸ ä¸€æ™‚åœæ­¢');
                            playPause.setAttribute('aria-label', 'ä¸€æ™‚åœæ­¢');
                        }).catch(error => {
                            console.error('å†ç”Ÿã‚¨ãƒ©ãƒ¼:', error);
                            // ã‚¨ãƒ©ãƒ¼ã‚¿ã‚¤ãƒ—ã«åŸºã¥ã„ã¦ã‚ˆã‚Šå…·ä½“çš„ãªãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
                            let userMessage = 'ã‚ªãƒ¼ãƒ‡ã‚£ã‚ªã®å†ç”Ÿä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚';
                            if (error.name === 'NotAllowedError') {
                                userMessage = 'ãƒ–ãƒ©ã‚¦ã‚¶ã®åˆ¶é™ã«ã‚ˆã‚Šè‡ªå‹•å†ç”Ÿã§ãã¾ã›ã‚“ã§ã—ãŸã€‚å†ç”Ÿãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãã ã•ã„ã€‚';
                            } else if (error.name === 'NotSupportedError') {
                                userMessage = 'ã‚ªãƒ¼ãƒ‡ã‚£ã‚ªå½¢å¼ãŒã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ãªã„å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚';
                            }
                            showError(userMessage);
                            // ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿæ™‚ã¯å†ç”Ÿãƒœã‚¿ãƒ³ã«æˆ»ã™
                            safeSetText(playPause, 'â–¶ å†ç”Ÿ');
                            playPause.setAttribute('aria-label', 'å†ç”Ÿ');
                        });
                    }
                } else {
                    audio.pause();
                    safeSetText(playPause, 'â–¶ å†ç”Ÿ');
                    playPause.setAttribute('aria-label', 'å†ç”Ÿ');
                }
            }

            // 10ç§’å·»ãæˆ»ã—
            function rewindAudio() {
                audio.currentTime = Math.max(0, audio.currentTime - 10);
                updateSeekBarAndChapter(); // å³æ™‚æ›´æ–°
            }

            // 10ç§’æ—©é€ã‚Š
            function forwardAudio() {
                audio.currentTime = Math.min(audio.duration || 0, audio.currentTime + 10);
                updateSeekBarAndChapter(); // å³æ™‚æ›´æ–°
            }

            // æ™‚é–“ã‚’ç§’ã‹ã‚‰èª­ã¿ä¸Šã’å¯èƒ½ãªãƒ†ã‚­ã‚¹ãƒˆå½¢å¼ã«å¤‰æ›
            function formatTimeForAria(seconds) {
                if (isNaN(seconds)) return "0ç§’";
                const minutes = Math.floor(seconds / 60);
                const remainingSeconds = Math.floor(seconds % 60);
                let text = "";
                if (minutes > 0) {
                    text += `${minutes}åˆ†`;
                }
                if (remainingSeconds > 0 || minutes === 0) {
                    text += `${remainingSeconds}ç§’`;
                }
                return text || "0ç§’";
            }

            // ã‚·ãƒ¼ã‚¯ãƒãƒ¼ã®æ›´æ–°ã¨æ“ä½œ - æœ€é©åŒ–ç‰ˆ (ã‚¹ãƒ­ãƒƒãƒˆãƒªãƒ³ã‚°é©ç”¨)
            const throttledUpdateSeekBar = throttle(() => {
                if (!isSeeking && !isNaN(audio.duration) && audio.duration > 0) {
                    const percent = (audio.currentTime / audio.duration) * 100;
                    seekBar.value = percent;
                    const currentTimeFormatted = formatTime(audio.currentTime);
                    safeSetText(currentTimeDisplay, currentTimeFormatted);
                    // ã‚¢ã‚¯ã‚»ã‚·ãƒ“ãƒªãƒ†ã‚£å‘ä¸Š: aria-valuetext æ›´æ–°
                    seekBar.setAttribute('aria-valuetext', formatTimeForAria(audio.currentTime));
                    updateChapterSelectBasedOnTime();
                }
            }, 250); // 250msé–“éš”ã§æ›´æ–°

            // ã‚·ãƒ¼ã‚¯ãƒãƒ¼ã¨è¡¨ç¤ºã‚’å³æ™‚ã«æ›´æ–°ã™ã‚‹é–¢æ•° (å·»ãæˆ»ã—/æ—©é€ã‚Š/ãƒãƒ£ãƒ—ã‚¿ãƒ¼å¤‰æ›´ç”¨)
            function updateSeekBarAndChapter() {
                if (!isNaN(audio.duration) && audio.duration > 0) {
                    const percent = (audio.currentTime / audio.duration) * 100;
                    seekBar.value = percent;
                    const currentTimeFormatted = formatTime(audio.currentTime);
                    safeSetText(currentTimeDisplay, currentTimeFormatted);
                    // ã‚¢ã‚¯ã‚»ã‚·ãƒ“ãƒªãƒ†ã‚£å‘ä¸Š: aria-valuetext æ›´æ–°
                    seekBar.setAttribute('aria-valuetext', formatTimeForAria(audio.currentTime));
                    updateChapterSelectBasedOnTime();
                } else {
                    // durationãŒã¾ã ä¸æ˜ãªå ´åˆã‚„0ã®å ´åˆã®åˆæœŸçŠ¶æ…‹
                    seekBar.value = 0;
                    safeSetText(currentTimeDisplay, '0:00');
                    seekBar.setAttribute('aria-valuetext', '0ç§’');
                    updateChapterSelectBasedOnTime(); // ãƒãƒ£ãƒ—ã‚¿ãƒ¼ã‚‚åˆæœŸåŒ–
                }
            }


            // ç¾åœ¨ã®å†ç”Ÿä½ç½®ã«åŸºã¥ã„ã¦ãƒãƒ£ãƒ—ã‚¿ãƒ¼ã‚»ãƒ¬ã‚¯ãƒˆã‚’æ›´æ–°ï¼ˆæœ€é©åŒ–ï¼‰
            function updateChapterSelectBasedOnTime() {
                const currentTime = audio.currentTime;
                const options = chapterSelect.options;
                let selectedIndex = 0;

                for (let i = options.length - 1; i >= 0; i--) {
                    const optionTime = parseFloat(options[i].value);
                    // options[i].value ãŒæ•°å€¤ã§ãªã„å ´åˆã‚’è€ƒæ…®
                    if (!isNaN(optionTime) && currentTime >= optionTime) {
                        selectedIndex = i;
                        break;
                    }
                }

                if (chapterSelect.selectedIndex !== selectedIndex) {
                    chapterSelect.selectedIndex = selectedIndex;
                }
            }

            // å†ç”Ÿé€Ÿåº¦ã®å¤‰æ›´ï¼ˆæœ€é©åŒ–ï¼‰
            function changePlaybackRate(event) {
                const target = event.target;
                // .speed-button ã‹ã¤ disabled ã§ãªã„ã“ã¨ã‚’ç¢ºèª
                if (target.classList.contains('speed-button') && !target.disabled) {
                    const speed = parseFloat(target.getAttribute('data-speed'));
                    if (!isNaN(speed)) {
                        audio.playbackRate = speed;

                        // æœ€é©åŒ–: ã‚³ãƒ³ãƒ†ãƒŠå†…ã§ãƒœã‚¿ãƒ³ã‚’æ¤œç´¢
                        const buttons = speedButtonsContainer.querySelectorAll('.speed-button');
                        buttons.forEach(button => button.classList.remove('active'));
                        target.classList.add('active');

                        settings.speed = speed; // ä¿å­˜ç”¨ã«æ›´æ–°
                    }
                }
            }


            // éŸ³é‡ã‚¢ã‚¤ã‚³ãƒ³ã®æ›´æ–°
            function updateVolumeIcon() {
                const volume = audio.volume;
                const muted = audio.muted; // ãƒŸãƒ¥ãƒ¼ãƒˆçŠ¶æ…‹ã‚‚è€ƒæ…®
                let icon = 'ğŸ”Š';
                let label = 'ãƒŸãƒ¥ãƒ¼ãƒˆåˆ‡ã‚Šæ›¿ãˆ';

                if (muted || volume === 0) {
                    icon = 'ğŸ”‡';
                    label = 'ãƒŸãƒ¥ãƒ¼ãƒˆè§£é™¤';
                } else if (volume < 0.5) {
                    icon = 'ğŸ”‰';
                }

                safeSetText(volumeIcon, icon);
                volumeIcon.setAttribute('aria-label', label);
            }

            // ãƒŸãƒ¥ãƒ¼ãƒˆåˆ‡ã‚Šæ›¿ãˆ
            function toggleMute() {
                audio.muted = !audio.muted; // audioè¦ç´ ã®mutedãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚’ä½¿ç”¨
                // è¦‹ãŸç›®ã®åŒæœŸ (å¿…é ˆã§ã¯ãªã„ãŒã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½“é¨“å‘ä¸Š)
                if (audio.muted) {
                    previousVolume = audio.volume; // ãƒŸãƒ¥ãƒ¼ãƒˆå‰ã®éŸ³é‡ã‚’ä¿å­˜
                    volumeControl.value = 0; // ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã‚’0ã«ã™ã‚‹
                } else {
                    // ãƒŸãƒ¥ãƒ¼ãƒˆè§£é™¤æ™‚ã€å…ƒã®éŸ³é‡ã«æˆ»ã™ã‹ã€æœ€å°éŸ³é‡ã«ã™ã‚‹ã‹é¸æŠ
                    // ã“ã“ã§ã¯ãƒŸãƒ¥ãƒ¼ãƒˆå‰ã®éŸ³é‡ã«æˆ»ã™
                    audio.volume = previousVolume > 0 ? previousVolume : 0.1; // 0ã ã£ãŸå ´åˆã¯å°‘ã—éŸ³é‡ã‚’å‡ºã™
                    volumeControl.value = audio.volume;
                }

                updateVolumeIcon();
                // ãƒŸãƒ¥ãƒ¼ãƒˆçŠ¶æ…‹è‡ªä½“ã¯ä¿å­˜ã›ãšã€éŸ³é‡ã®ã¿ä¿å­˜ (settings.volumeã¯ãƒãƒ³ãƒ‰ãƒ«å†…ã§æ›´æ–°)
                settings.volume = audio.volume; // ãƒŸãƒ¥ãƒ¼ãƒˆçŠ¶æ…‹ã«é–¢ã‚ã‚‰ãšç¾åœ¨ã®éŸ³é‡ã‚’ä¿å­˜å¯¾è±¡ã¨ã™ã‚‹
            }


            // æ™‚é–“ã®ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆï¼ˆç§’ã‚’MM:SSå½¢å¼ã«å¤‰æ›ï¼‰- æœ€é©åŒ–ç‰ˆ
            function formatTime(seconds) {
                if (isNaN(seconds) || seconds < 0) return "0:00"; // ä¸æ­£ãªå€¤ã¯0:00ã«
                const minutes = Math.floor(seconds / 60);
                const remainingSeconds = Math.floor(seconds % 60);
                return `${minutes}:${remainingSeconds < 10 ? '0' : ''}${remainingSeconds}`;
            }

            // ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ã‚¤ãƒ™ãƒ³ãƒˆã®å‡¦ç† - ã‚¤ãƒ™ãƒ³ãƒˆå§”ä»»ã‚’ä½¿ç”¨
            function handleControlsClick(event) {
                const target = event.target.closest('button'); // ãƒœã‚¿ãƒ³è‡ªä½“ã¾ãŸã¯ãã®å­è¦ç´ ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ãŸå ´åˆã«å¯¾å¿œ
                if (!target || target.disabled) return; // disabledãªã‚‰ç„¡è¦–

                switch (target.id) {
                    case 'playPause':
                        togglePlayPause();
                        break;
                    case 'rewind':
                        rewindAudio();
                        break;
                    case 'forward':
                        forwardAudio();
                        break;
                }
            }

            // ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©ï¼ˆã‚¹ãƒ­ãƒƒãƒˆãƒªãƒ³ã‚°é©ç”¨ï¼‰
            const handleGlobalKeydown = throttle((e) => {
                // ãƒ†ã‚­ã‚¹ãƒˆå…¥åŠ›ä¸­ãªã©ã¯ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆã‚’ç„¡åŠ¹åŒ–
                const activeEl = document.activeElement;
                const isTextInput = activeEl.tagName === 'INPUT' || activeEl.tagName === 'TEXTAREA' || activeEl.isContentEditable;

                if (isTextInput) return; // ãƒ†ã‚­ã‚¹ãƒˆå…¥åŠ›ä¸­ã¯ç„¡è¦–

                // ã‚¹ãƒšãƒ¼ã‚¹ã‚­ãƒ¼ã§ã®å†ç”Ÿ/ä¸€æ™‚åœæ­¢ (ãƒœã‚¿ãƒ³/ã‚»ãƒ¬ã‚¯ãƒˆä»¥å¤–ã«ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ãŒã‚ã‚‹å ´åˆ)
                if (e.code === 'Space' && activeEl.tagName !== 'BUTTON' && activeEl.tagName !== 'SELECT' && activeEl !== volumeIcon) {
                    e.preventDefault();
                    togglePlayPause();
                }

                // å·¦å³çŸ¢å°ã‚­ãƒ¼ã§å·»ãæˆ»ã—/æ—©é€ã‚Š (ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼/ã‚»ãƒ¬ã‚¯ãƒˆ/éŸ³é‡ã‚¢ã‚¤ã‚³ãƒ³ä»¥å¤–ã«ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ãŒã‚ã‚‹å ´åˆ)
                if (activeEl !== seekBar && activeEl !== volumeControl && activeEl !== chapterSelect && activeEl !== volumeIcon) {
                    if (e.code === 'ArrowLeft') {
                        e.preventDefault(); // ãƒšãƒ¼ã‚¸ã®ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚’é˜²ãå ´åˆ
                        rewindAudio();
                    } else if (e.code === 'ArrowRight') {
                        e.preventDefault(); // ãƒšãƒ¼ã‚¸ã®ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚’é˜²ãå ´åˆ
                        forwardAudio();
                    }
                }

                // Mã‚­ãƒ¼ã§ãƒŸãƒ¥ãƒ¼ãƒˆåˆ‡ã‚Šæ›¿ãˆ
                if (e.code === 'KeyM') {
                    toggleMute();
                }

            }, 150); // 150msã®ã‚¹ãƒ­ãƒƒãƒˆãƒªãƒ³ã‚°

            // ãƒãƒ£ãƒ—ã‚¿ãƒ¼é¸æŠãƒãƒ³ãƒ‰ãƒ©
            function handleChapterChange() {
                const chapterTime = parseFloat(chapterSelect.value);
                if (!isNaN(chapterTime)) {
                    audio.currentTime = chapterTime;
                    updateSeekBarAndChapter(); // å³æ™‚æ›´æ–°
                    // ä¿®æ­£: è‡ªå‹•å†ç”Ÿã¯è¡Œã‚ãªã„
                }
            }

            // éŸ³é‡å¤‰æ›´ãƒãƒ³ãƒ‰ãƒ©
            function handleVolumeChange() {
                const newVolume = parseFloat(volumeControl.value);
                audio.volume = newVolume;
                // audio.muted ã¯ volumechange ã‚¤ãƒ™ãƒ³ãƒˆå†…ã§è‡ªå‹•æ›´æ–°ã•ã‚Œã‚‹ã“ã¨ãŒå¤šã„ãŒã€æ˜ç¤ºçš„ã«åŒæœŸ
                audio.muted = (newVolume === 0);

                if (newVolume > 0 && !audio.muted) { // ãƒŸãƒ¥ãƒ¼ãƒˆã•ã‚Œã¦ãŠã‚‰ãšã€éŸ³é‡ãŒã‚ã‚‹å ´åˆã®ã¿previousVolumeæ›´æ–°
                    previousVolume = newVolume;
                }

                updateVolumeIcon(); // ã‚¢ã‚¤ã‚³ãƒ³æ›´æ–°ã¯ volumechange ã‚¤ãƒ™ãƒ³ãƒˆã«ä»»ã›ã¦ã‚‚è‰¯ã„ãŒã€å³æ™‚åæ˜ ã®ãŸã‚ã«ã“ã“ã§ã‚‚å‘¼ã¶
                settings.volume = audio.volume; // ä¿å­˜ç”¨ã«æ›´æ–°
            }


            // ã‚·ãƒ¼ã‚¯ãƒãƒ¼å…¥åŠ›ãƒãƒ³ãƒ‰ãƒ© (ãƒ‰ãƒ©ãƒƒã‚°ä¸­)
            function handleSeekBarInput() {
                isSeeking = true; // ã‚·ãƒ¼ã‚¯ä¸­ãƒ•ãƒ©ã‚°ã‚’ç«‹ã¦ã‚‹
                // requestAnimationFrameã‚’ä½¿ç”¨ã—ã¦ã‚¹ãƒ ãƒ¼ã‚ºãªæ›´æ–°
                requestAnimationFrame(() => {
                    if (!isNaN(audio.duration) && audio.duration > 0) {
                        const seekTime = audio.duration * (seekBar.value / 100);
                        // currentTime ã¯ç›´æ¥è¨­å®šã›ãšã€è¡¨ç¤ºã®ã¿æ›´æ–°
                        safeSetText(currentTimeDisplay, formatTime(seekTime));
                        seekBar.setAttribute('aria-valuetext', formatTimeForAria(seekTime));
                    }
                });
            }

            // ã‚·ãƒ¼ã‚¯ãƒãƒ¼å¤‰æ›´å®Œäº†ãƒãƒ³ãƒ‰ãƒ© (ãƒã‚¦ã‚¹ã‚¢ãƒƒãƒ—/ã‚¿ãƒƒãƒã‚¨ãƒ³ãƒ‰/å€¤å¤‰æ›´å¾Œ)
            function handleSeekBarChange() {
                if (!isNaN(audio.duration) && audio.duration > 0) {
                    const seekTime = audio.duration * (seekBar.value / 100);
                    audio.currentTime = seekTime;
                }
                // isSeeking ãƒ•ãƒ©ã‚°ã¯ timeupdate ãƒãƒ³ãƒ‰ãƒ©å†…ã§ audio.seeking ã‚’è¦‹ã‚‹æ–¹ãŒç¢ºå®Ÿã‹ã‚‚ã—ã‚Œãªã„
                // ãŒã€ã“ã“ã§ã¯å…ƒã®ãƒ­ã‚¸ãƒƒã‚¯ã‚’ç¶­æŒ
                isSeeking = false; // ã‚·ãƒ¼ã‚¯å®Œäº†
                // ã‚·ãƒ¼ã‚¯å®Œäº†å¾Œã€UIã‚’æœ€çµ‚çŠ¶æ…‹ã«æ›´æ–°
                updateSeekBarAndChapter();
            }


            // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã™ã‚‹é–¢æ•°
            function setupEventListeners() {
                // ã‚ªãƒ¼ãƒ‡ã‚£ã‚ªã‚¤ãƒ™ãƒ³ãƒˆ
                audio.addEventListener('timeupdate', throttledUpdateSeekBar); // ã‚¹ãƒ­ãƒƒãƒˆãƒªãƒ³ã‚°ã•ã‚ŒãŸæ›´æ–°
                audio.addEventListener('loadedmetadata', () => {
                    safeSetText(durationDisplay, formatTime(audio.duration));
                    seekBar.max = 100; // durationãŒç¢ºå®šã—ãŸã‚‰maxã‚’è¨­å®š
                    updateSeekBarAndChapter(); // åˆæœŸä½ç½®åæ˜ ã®ãŸã‚
                });
                audio.addEventListener('durationchange', () => { // durationãŒå¤‰ã‚ã‚‹å¯èƒ½æ€§ã‚‚è€ƒæ…®
                    safeSetText(durationDisplay, formatTime(audio.duration));
                    seekBar.max = 100;
                    updateSeekBarAndChapter();
                });
                audio.addEventListener('volumechange', () => {
                    // audio.volume ã¾ãŸã¯ audio.muted ã®å¤‰æ›´ã‚’æ¤œçŸ¥
                    volumeControl.value = audio.muted ? 0 : audio.volume; // ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ä½ç½®ã‚’åŒæœŸ
                    if (!audio.muted && audio.volume > 0) {
                        previousVolume = audio.volume; // ãƒŸãƒ¥ãƒ¼ãƒˆè§£é™¤ç”¨ã«ä¿å­˜
                    }
                    updateVolumeIcon(); // ã‚¢ã‚¤ã‚³ãƒ³ã‚’æ›´æ–°
                    settings.volume = audio.volume; // è¨­å®šä¿å­˜ç”¨ã«æ›´æ–°
                });

                // ã‚ªãƒ¼ãƒ‡ã‚£ã‚ªã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
                audio.addEventListener('error', (e) => {
                    let errorMsg = 'ã‚ªãƒ¼ãƒ‡ã‚£ã‚ªãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ä¸­ã«ä¸æ˜ãªã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚';
                    if (audio.error) {
                        switch (audio.error.code) {
                            case 1: // MEDIA_ERR_ABORTED
                                errorMsg = 'ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ã‚ˆã£ã¦å†ç”ŸãŒä¸­æ­¢ã•ã‚Œã¾ã—ãŸã€‚';
                                break;
                            case 2: // MEDIA_ERR_NETWORK
                                errorMsg = 'ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚æ¥ç¶šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚';
                                break;
                            case 3: // MEDIA_ERR_DECODE
                                errorMsg = 'ã‚ªãƒ¼ãƒ‡ã‚£ã‚ªã®ãƒ‡ã‚³ãƒ¼ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒ•ã‚¡ã‚¤ãƒ«ãŒç ´æã—ã¦ã„ã‚‹ã‹ã€å½¢å¼ãŒã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚';
                                break;
                            case 4: // MEDIA_ERR_SRC_NOT_SUPPORTED
                                errorMsg = 'ã‚ªãƒ¼ãƒ‡ã‚£ã‚ªãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚‰ãªã„ã‹ã€ã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ãªã„å½¢å¼ã§ã™ã€‚';
                                break;
                        }
                    }
                    showError(errorMsg);
                    console.error('Audio error:', audio.error, e);
                    // ã‚¨ãƒ©ãƒ¼ã«ã‚ˆã£ã¦ã¯å†ç”Ÿãƒœã‚¿ãƒ³ã‚’ãƒªã‚»ãƒƒãƒˆ
                    safeSetText(playPause, 'â–¶ å†ç”Ÿ');
                    playPause.setAttribute('aria-label', 'å†ç”Ÿ');
                    // UIè¦ç´ ã‚’ç„¡åŠ¹åŒ–ã™ã‚‹ãªã©ã®å‡¦ç†ã‚‚æ¤œè¨
                    // ä¾‹: seekBar.disabled = true; controlsContainer.querySelectorAll('button').forEach(b => b.disabled = true);
                });

                // ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãƒœã‚¿ãƒ³ã‚¤ãƒ™ãƒ³ãƒˆ (ã‚¤ãƒ™ãƒ³ãƒˆå§”ä»»)
                controlsContainer.addEventListener('click', handleControlsClick);

                // å†ç”Ÿé€Ÿåº¦ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆå§”ä»»
                speedButtonsContainer.addEventListener('click', changePlaybackRate);

                // ã‚·ãƒ¼ã‚¯ãƒãƒ¼ã‚¤ãƒ™ãƒ³ãƒˆ
                seekBar.addEventListener('input', handleSeekBarInput);
                seekBar.addEventListener('change', handleSeekBarChange);
                seekBar.addEventListener('touchstart', () => isSeeking = true, { passive: true });
                seekBar.addEventListener('touchend', handleSeekBarChange); // touchendã§ã‚‚changeã¨åŒæ§˜ã®å‡¦ç†


                // ãƒãƒ£ãƒ—ã‚¿ãƒ¼é¸æŠã‚¤ãƒ™ãƒ³ãƒˆ
                chapterSelect.addEventListener('change', handleChapterChange);

                // éŸ³é‡ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ã‚¤ãƒ™ãƒ³ãƒˆ
                volumeControl.addEventListener('input', handleVolumeChange);
                volumeIcon.addEventListener('click', toggleMute);
                volumeIcon.addEventListener('keydown', (e) => {
                    // Enter or Spaceã§ãƒŸãƒ¥ãƒ¼ãƒˆåˆ‡ã‚Šæ›¿ãˆ
                    if (e.code === 'Enter' || e.code === 'Space') {
                        e.preventDefault(); // ãƒœã‚¿ãƒ³ã¨ã—ã¦ã®æŒ™å‹•ï¼ˆã‚¹ãƒšãƒ¼ã‚¹ã§ã®ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãªã©ï¼‰ã‚’æŠ‘åˆ¶
                        toggleMute();
                    }
                });

                // ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆ
                document.addEventListener('keydown', handleGlobalKeydown);

                // å†ç”Ÿçµ‚äº†æ™‚ã®å‡¦ç†
                audio.addEventListener('ended', () => {
                    safeSetText(playPause, 'â–¶ å†ç”Ÿ');
                    playPause.setAttribute('aria-label', 'å†ç”Ÿ');
                    audio.currentTime = 0; // å†ç”Ÿä½ç½®ã‚’æœ€åˆã«æˆ»ã™ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
                    updateSeekBarAndChapter(); // UIã‚’æ›´æ–°
                    // å¿…è¦ã§ã‚ã‚Œã°æ¬¡ã®ãƒˆãƒ©ãƒƒã‚¯ã¸ç§»å‹•ãªã©ã®ãƒ­ã‚¸ãƒƒã‚¯ã‚’ã“ã“ã«è¿½åŠ 
                    saveSettings(); // å†ç”Ÿçµ‚äº†æ™‚ã«ã‚‚çŠ¶æ…‹ã‚’ä¿å­˜
                });

                // ãƒšãƒ¼ã‚¸è¡¨ç¤ºçŠ¶æ…‹å¤‰æ›´æ™‚ã®ä¿å­˜ (ã‚ˆã‚Šä¿¡é ¼æ€§ãŒé«˜ã„)
                document.addEventListener('visibilitychange', () => {
                    if (document.visibilityState === 'hidden') {
                        saveSettings();
                    }
                });

                // ãƒšãƒ¼ã‚¸é›¢è„±å‰ã®ä¿å­˜ (ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯)
                window.addEventListener('beforeunload', saveSettings);
            }

            // åˆæœŸåŒ–
            function init() {
                const savedSettings = getSavedSettings();
                // console.log('Loaded settings:', savedSettings); // ãƒ‡ãƒãƒƒã‚°ç”¨

                // éŸ³é‡è¨­å®š (volumechangeã‚¤ãƒ™ãƒ³ãƒˆã«ä¾å­˜ã›ãšåˆæœŸåŒ–)
                let initialVolume = 1;
                if (savedSettings.volume !== undefined) {
                    const volume = parseFloat(savedSettings.volume);
                    if (!isNaN(volume)) {
                        initialVolume = volume;
                    }
                } else {
                    initialVolume = parseFloat(volumeControl.value); // HTMLã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤
                }
                audio.volume = initialVolume;
                audio.muted = (initialVolume === 0); // 0ãªã‚‰ãƒŸãƒ¥ãƒ¼ãƒˆ
                volumeControl.value = audio.muted ? 0 : audio.volume; // ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã‚‚åŒæœŸ
                previousVolume = initialVolume > 0 ? initialVolume : 1; // ãƒŸãƒ¥ãƒ¼ãƒˆè§£é™¤ç”¨
                updateVolumeIcon(); // åˆæœŸã‚¢ã‚¤ã‚³ãƒ³è¨­å®š

                // å†ç”Ÿé€Ÿåº¦
                if (savedSettings.speed !== undefined) {
                    const speed = parseFloat(savedSettings.speed);
                    if (!isNaN(speed)) {
                        audio.playbackRate = speed;
                        // æœ€é©åŒ–: ã‚³ãƒ³ãƒ†ãƒŠå†…ã§ãƒœã‚¿ãƒ³ã‚’æ¤œç´¢
                        const buttons = speedButtonsContainer.querySelectorAll('.speed-button');
                        buttons.forEach(button => {
                            button.classList.toggle('active', parseFloat(button.getAttribute('data-speed')) === speed);
                        });
                    }
                } // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯HTMLã§æŒ‡å®šã•ã‚ŒãŸ 'active' ã‚¯ãƒ©ã‚¹ã«å¾“ã†

                // å‰å›ã®å†ç”Ÿä½ç½® (ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ãƒ­ãƒ¼ãƒ‰å¾Œã«è¨­å®š)
                const applyInitialPosition = () => {
                    // ãƒªã‚¹ãƒŠãƒ¼å‰Šé™¤
                    audio.removeEventListener('loadedmetadata', applyInitialPositionHandler);
                    audio.removeEventListener('durationchange', applyInitialPositionHandler);

                    if (savedSettings.position !== undefined) {
                        const position = parseFloat(savedSettings.position);
                        // duration ãŒæœ‰åŠ¹ãªå ´åˆã«ã®ã¿ä½ç½®ã‚’è¨­å®š
                        if (!isNaN(position) && !isNaN(audio.duration) && audio.duration > 0 && position < audio.duration) {
                            // å°‘ã—å¾…ã£ã¦ã‹ã‚‰è¨­å®šã™ã‚‹ã¨å®‰å®šã™ã‚‹å ´åˆãŒã‚ã‚‹
                            setTimeout(() => {
                                audio.currentTime = position;
                                updateSeekBarAndChapter(); // UIæ›´æ–°ã‚‚é…å»¶å¾Œã«
                            }, 100); // 100mså¾…ã¤ (å¿…è¦ã«å¿œã˜ã¦èª¿æ•´)
                        } else {
                            updateSeekBarAndChapter(); // ä½ç½®è¨­å®šã—ãªã„å ´åˆã‚‚UIæ›´æ–°
                        }
                    } else {
                        updateSeekBarAndChapter(); // ä¿å­˜ã•ã‚ŒãŸä½ç½®ãŒãªã„å ´åˆã‚‚UIæ›´æ–°
                    }
                };

                // loadedmetadata / durationchange ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©
                const applyInitialPositionHandler = () => {
                    // readyStateã‚’ç¢ºèªã—ã¦ã‹ã‚‰å®Ÿè¡Œ
                    if (audio.readyState >= 1) { // HAVE_METADATA or higher
                        applyInitialPosition();
                    }
                };


                // audio ã®æº–å‚™çŠ¶æ…‹ã«å¿œã˜ã¦ãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®š
                if (audio.readyState >= 1) { // HAVE_METADATA or higher
                    // ã™ã§ã«ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Œã°å°‘ã—å¾…ã£ã¦ã‹ã‚‰ä½ç½®è¨­å®šã‚’è©¦ã¿ã‚‹
                    setTimeout(() => {
                        applyInitialPosition();
                    }, 100);
                } else {
                    // ã¾ã ãªã‚‰ã‚¤ãƒ™ãƒ³ãƒˆã‚’å¾…ã¤
                    audio.addEventListener('loadedmetadata', applyInitialPositionHandler, { once: true }); // ä¸€åº¦ã ã‘å®Ÿè¡Œ
                    audio.addEventListener('durationchange', applyInitialPositionHandler, { once: true }); // durationchange ã‚‚ä¸€åº¦ã ã‘listen
                }


                // å®šæœŸä¿å­˜ã¯å»ƒæ­¢
                // clearInterval(backupInterval); // ä¸è¦

                // Inertå±æ€§ã®åˆæœŸè¨­å®š
                if ('inert' in HTMLElement.prototype) {
                    errorMessage.inert = true; // æœ€åˆã¯éè¡¨ç¤ºãªã®ã§inert
                }

                // åˆæœŸUIçŠ¶æ…‹æ›´æ–°
                updateSeekBarAndChapter();
            }

            // ãƒ¡ãƒ¢ãƒªãƒªãƒ¼ã‚¯ã‚’é˜²ããŸã‚ã®ãƒªã‚½ãƒ¼ã‚¹è§£æ”¾é–¢æ•° (ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆç¶­æŒ)
            function cleanupResources() {
                // console.log("Resources cleaned up."); // ãƒ‡ãƒãƒƒã‚°ç”¨
            }

            // ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œ
            function runApp() {
                init();
                setupEventListeners();
            }

            // DOMãŒå®Œå…¨ã«èª­ã¿è¾¼ã¾ã‚ŒãŸã‚‰åˆæœŸåŒ–
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', runApp);
            } else {
                runApp(); // ã™ã§ã«èª­ã¿è¾¼ã¿å®Œäº†ã—ã¦ã„ã‚‹å ´åˆ
            }
        })();
    </script>
</body>

</html>
